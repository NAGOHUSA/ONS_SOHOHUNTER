<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>SOHO Comet Hunter â€“ Professional Dashboard</title>
  <link rel="icon" href="https://soho.nascom.nasa.gov/favicon.ico">
  <style>
    :root{
      --bg-primary:#05080f; --bg-elev:#0c1221; --bg-card:#10172a;
      --border:#1b2640; --border-strong:#2a3a60;
      --text-primary:#e9eef7; --text-secondary:#a6b3cf; --text-tertiary:#7c8db1;
      --accent:#4a9eff; --accent-2:#2f80ff; --accent-glow:rgba(74,158,255,.20);
      --success:#22c55e; --danger:#ef4444; --warn:#fbbf24;
      --radius:14px; --radius-sm:10px;
      --shadow:0 8px 28px rgba(0,0,0,.45); --shadow-sm:0 6px 16px rgba(0,0,0,.35);
      --font-ui:-apple-system,BlinkMacSystemFont,'SF Pro Text','Segoe UI',Roboto,Inter,Helvetica,Arial,sans-serif;
      --mono:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0; font-family:var(--font-ui); color:var(--text-primary);
      background:
        radial-gradient(1200px 600px at 50% -200px,rgba(42,60,120,.35),transparent 70%),
        linear-gradient(180deg,#060B15 0%, #060913 100%);
      background-color:var(--bg-primary);
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    .appbar{position:sticky;top:0;z-index:1000;backdrop-filter:saturate(140%) blur(14px);
      background:color-mix(in oklab, var(--bg-elev) 90%, transparent);
      border-bottom:1px solid var(--border);}
    .container{max-width:1320px;margin:0 auto;padding:0 16px}
    .appbar-row{display:flex;align-items:center;justify-content:space-between;min-height:60px;gap:12px;padding:10px 0;}
    .brand-title h1{margin:0;font-size:20px;font-weight:800;letter-spacing:-.2px;
      background:linear-gradient(135deg,#fff 0%,#bfe0ff 45%,#84b8ff 95%);
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
    .brand-sub{margin:0;font-size:12px;color:var(--text-tertiary)}
    .appbar-actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .status{display:flex;align-items:center;gap:8px;padding:6px 12px;border-radius:999px;font-weight:700;font-size:12px;
      color:#0f2a18;background:linear-gradient(180deg,#A6F4C5,#59d68a)}
    .dot{width:8px;height:8px;border-radius:999px;background:#16a34a;box-shadow:0 0 10px #22c55e}
    .btn{appearance:none;border:1px solid var(--border-strong);
      background:linear-gradient(180deg, var(--bg-card), #0b1326);color:var(--text-primary);
      border-radius:12px;padding:9px 14px;font-weight:700;font-size:13px;cursor:pointer;
      transition:.15s;border-color:var(--border-strong)}
    .btn:hover{border-color:var(--accent);box-shadow:0 0 0 4px var(--accent-glow)}
    .btn.primary{border-color:transparent;background:linear-gradient(180deg,var(--accent),var(--accent-2));color:#fff}
    .btn.sm{padding:8px 12px;font-size:12px;border-radius:10px}
    .toolbar{border-top:1px solid var(--border);border-bottom:1px solid var(--border);
      background:color-mix(in oklab, var(--bg-elev) 88%, transparent);}
    .toolbar-grid{display:grid;gap:12px;padding:12px 0;grid-template-columns:repeat(12,1fr);align-items:end}
    .group{display:flex;flex-direction:column;gap:6px}
    .label{font-size:11px;text-transform:uppercase;letter-spacing:.08em;color:var(--text-tertiary);font-weight:800}
    .select,.input{
      width:100%;height:44px;padding:0 14px;border-radius:12px;border:1.5px solid var(--border-strong);
      background:#0b1326;color:var(--text-primary);font-size:15px;appearance:none;
      text-align:left; text-align-last:left;
      box-shadow:inset 0 1px 0 rgba(255,255,255,.03);
    }
    .select:focus,.input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 4px var(--accent-glow)}
    .filters{display:flex;gap:8px;flex-wrap:wrap;align-items:center;padding-top:6px}
    .chip{display:inline-flex;align-items:center;gap:8px;height:36px;padding:0 12px;border-radius:999px;border:1px solid var(--border-strong);
      background:var(--bg-card);font-weight:700;font-size:12px;color:var(--text-secondary);cursor:pointer}
    .chip input{accent-color:var(--accent);width:16px;height:16px}
    .export-row{display:flex;align-items:center;gap:8px;white-space:nowrap;overflow:auto;padding-bottom:2px}
    .divider{width:1px;height:24px;background:var(--border-strong);flex:0 0 auto;opacity:.8}
    .col-4{grid-column:span 4} .col-3{grid-column:span 3} .col-5{grid-column:span 5} .col-12{grid-column:1/-1}
    @media (max-width:1200px){.col-4,.col-3,.col-5{grid-column:span 6}}
    @media (max-width:820px){.toolbar-grid{grid-template-columns:repeat(6,1fr)} .col-4,.col-3,.col-5{grid-column:1/-1}}
    @media (max-width:480px){.toolbar-grid{grid-template-columns:repeat(4,1fr)}}
    main{padding:18px 0}
    .stats{display:grid;gap:12px;grid-template-columns:repeat(6,1fr)}
    .stat{border:1px solid var(--border);background:linear-gradient(180deg,var(--bg-card),#0b1326);
      border-radius:var(--radius);padding:14px;box-shadow:var(--shadow-sm)}
    .stat .k{font-size:11px;text-transform:uppercase;color:var(--text-tertiary);letter-spacing:.08em;font-weight:800}
    .stat .v{margin-top:6px;font-size:28px;font-weight:900;background:linear-gradient(135deg,#fff,#a9d1ff);
      -webkit-background-clip:text;-webkit-text-fill-color:transparent}
    @media (max-width:1200px){.stats{grid-template-columns:repeat(3,1fr)}}
    @media (max-width:820px){.stats{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:480px){.stats{grid-template-columns:1fr}}
    .live{display:grid;gap:12px;margin-top:14px;grid-template-columns:repeat(2,1fr)}
    @media (max-width:820px){.live{grid-template-columns:1fr}}
    .feed{border:1px solid var(--border);background:linear-gradient(180deg,var(--bg-card),#0b1326);
      border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow-sm)}
    .feed-h{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--border);
      background:linear-gradient(180deg, color-mix(in oklab, var(--accent) 10%, transparent), transparent)}
    .badge{font-size:11px;padding:4px 10px;border-radius:999px;background:linear-gradient(180deg,var(--accent),var(--accent-2));color:#fff;font-weight:800}
    .feed-b{aspect-ratio:1;background:#000;display:flex;align-items:center;justify-content:center}
    .feed-b img{width:100%;height:100%;object-fit:contain}
    .feed-b video{width:100%;height:100%;object-fit:contain}
    .feed.gif-hidden .feed-b {display:none;}
    .feed-f{display:flex;justify-content:space-between;padding:10px 14px;color:var(--text-secondary);font-size:12px;background:rgba(255,255,255,.03)}
    .section-row{margin-top:18px;display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .h2{font-size:20px;font-weight:900;letter-spacing:-.2px;background:linear-gradient(135deg,#fff,#c6e0ff);
      -webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .grid{display:grid;gap:12px;margin-top:10px;grid-template-columns:repeat(12,1fr)}
    .card{grid-column:span 4;border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;
      background:linear-gradient(180deg,var(--bg-card),#0b1326);box-shadow:var(--shadow-sm);transition:.15s;cursor:pointer}
    .card:hover{transform:translateY(-2px);box-shadow:0 10px 30px rgba(0,0,0,.45);border-color:var(--accent)}
    @media (max-width:1200px){.card{grid-column:span 6}} @media (max-width:8...(truncated 48414 characters)...rstDate}\n`;
  doc += `Frames (time_utc, x, y):\n`;

  const lines = sungrazerLinesFromPositions(c);
  lines.forEach(L => {
    const [time, x, y] = L.split(' ');
    const iso = c.timestamp || time;
    const fullTime = iso.length > 8 ? new Date(iso).toISOString().replace('T', ' ').slice(0, 19) : iso;
    doc += `  ${fullTime}, ${x}, ${y}\n`;
  });

  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([doc], {type:'text/plain;charset=utf-8'}));
  a.download = `sungrazer_${c.id.replace(/\W+/g,'_')}.txt`;
  a.click();
  setTimeout(() => URL.revokeObjectURL(a.href), 1000);
}

    function exportSungrazerSingle(c){
      const objLine = (els.sungrazerObject.value || 'Kreutz Companion').trim();
      const inst = c.telescope.includes('C2') ? 'C2' : (c.telescope.includes('C3') ? 'C3' : (c.telescope.includes('CCOR') ? 'CCOR1' : 'UNKNOWN'));
      const lines = sungrazerLinesFromPositions(c);
      let doc = '1024x1024 images\n' + inst + '\n' + objLine + '\n';
      if (lines.length) lines.forEach(L => { doc += `${L}\n`; });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([doc], {type:'text/plain;charset=utf-8'}));
      a.download = `sungrazer_${c.id.replace(/\W+/g,'_')}.txt`;
      a.click(); setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
    }

    function exportCandidatePackage(c){
      const payload = {
        id: c.id,
        telescope: c.telescope,
        label: c.label,
        score: c.score,
        timestamp: c.timestamp,
        centroid: (Number.isFinite(c.cx)&&Number.isFinite(c.cy)) ? {x:c.cx,y:c.cy} : null,
        bbox: c.bbox,
        positions: Array.isArray(c.positions) ? c.positions : [],
        assets: {
          original: c.originalPath ? normPath(c.originalPath) : '',
          annotated_full: c.annotatedFull ? normPath(c.annotatedFull) : '',
          crop: c.cropPath ? normPath(c.cropPath) : '',
          gif: c.gifAnn ? normPath(c.gifAnn) : (c.gifCrop ? normPath(c.gifCrop) : ''),
          mp4: c.mp4 ? normPath(c.mp4) : ''
        },
        report: c.reportName || null
      };
      downloadText(`candidate_${c.id.replace(/\W+/g,'_')}.json`, JSON.stringify(payload, null, 2));
    }

    function updateLiveStamps(){
      const t = new Date();
      const hh = String(t.getUTCHours()).padStart(2,'0');
      const mm = String(t.getUTCMinutes()).padStart(2,'0');
      els.c2Timestamp.textContent = `${hh}:${mm} UTC`;
      els.c3Timestamp.textContent = `${hh}:${mm} UTC`;
      els.ccor1Timestamp.textContent = `${hh}:${mm} UTC`;
    }

    function startCountdown(seconds=300){
      let s = seconds;
      const tick = ()=>{
        const m = String(Math.floor(s/60)).padStart(1,'0');
        const r = String(s%60).padStart(2,'0');
        els.countdown.textContent = `${m}:${r}`;
        if (s<=0){ refreshAll(); s=seconds; } else { s--; }
      };
      tick(); setInterval(tick, 1000);
    }

    function refreshAll(){
      const sel = els.reportSelect.value;
      if (sel) loadReport(sel);
      updateLiveStamps();
    }

    function toggleLiveGif(feedId, btnId, mediaId, tsId){
      const feed = document.getElementById(feedId);
      const btn = document.getElementById(btnId);
      const media = document.getElementById(mediaId);
      const hidden = feed.classList.toggle('gif-hidden');
      const type = mediaId.toLowerCase().includes('video') ? 'Animation' : 'GIF';
      btn.textContent = hidden ? `Show ${type}` : `Hide ${type}`;
      if (!hidden && !media.src) media.src = media.dataset.src || media.getAttribute('src');
    }

    document.addEventListener('DOMContentLoaded', () => {
      Object.assign(els, {
        reportSelect:      document.getElementById('reportSelect'),
        candidateSelect:   document.getElementById('candidateSelect'),
        cometSelect:       document.getElementById('cometSelect'),
        refreshBtn:        document.getElementById('refreshBtn'),
        countdown:         document.getElementById('countdown'),
        exportTxtBtn:      document.getElementById('exportTxtBtn'),
        exportCsvBtn:      document.getElementById('exportCsvBtn'),
        exportSungrazerBtn:document.getElementById('exportSungrazerBtn'),
        exportAllFlaggedBtn:document.getElementById('exportAllFlaggedBtn'),
        exportMarkedOnly:  document.getElementById('exportMarkedOnly'),
        sungrazerObject:   document.getElementById('sungrazerObject'),
        sungrazerInstrument:document.getElementById('sungrazerInstrument'),
        filterC2:          document.getElementById('filterC2'),
        filterC3:          document.getElementById('filterC3'),
        filterCCOR1:       document.getElementById('filterCCOR1'),
        filterComet:       document.getElementById('filterComet'),
        filterMarked:      document.getElementById('filterMarked'),
        showNotComet:      document.getElementById('showNotComet'),
        highlightOfficial: document.getElementById('highlightOfficial'),
        filterScore51:     document.getElementById('filterScore51'),
        candidatesGrid:    document.getElementById('candidatesGrid'),
        filterCount:       document.getElementById('filterCount'),
        emptyState:        document.getElementById('emptyState'),
        c2LiveGif:         document.getElementById('c2LiveGif'),
        c3LiveGif:         document.getElementById('c3LiveGif'),
        ccor1LiveVideo:    document.getElementById('ccor1LiveVideo'),
        c2Timestamp:       document.getElementById('c2Timestamp'),
        c3Timestamp:       document.getElementById('c3Timestamp'),
        ccor1Timestamp:    document.getElementById('ccor1Timestamp'),
        reloadDbBtn:       document.getElementById('reloadDbBtn'),
        dbStatus:          document.getElementById('dbStatus'),
        dbTableBody:       document.getElementById('dbTableBody'),
        reportStatus:      document.getElementById('reportStatus')
      });

      document.getElementById('toggleC2').addEventListener('click', () => toggleLiveGif('feedC2','toggleC2','c2LiveGif','c2Timestamp'));
      document.getElementById('toggleC3').addEventListener('click', () => toggleLiveGif('feedC3','toggleC3','c3LiveGif','c3Timestamp'));
      document.getElementById('toggleCCOR1').addEventListener('click', () => toggleLiveGif('feedCCOR1','toggleCCOR1','ccor1LiveVideo','ccor1Timestamp'));

      els.refreshBtn.addEventListener('click', refreshAll);
      els.reportSelect.addEventListener('change', e=> loadReport(e.target.value));
      els.candidateSelect.addEventListener('change', scheduleFilter);
      els.cometSelect.addEventListener('change', ()=>{ crossCheckCandidates(); scheduleFilter(); });
      ['filterC2','filterC3','filterCCOR1','filterComet','filterMarked','showNotComet','highlightOfficial','filterScore51'].forEach(id=>{
        els[id]?.addEventListener('change', scheduleFilter);
      });
      els.exportTxtBtn.addEventListener('click', exportTXT);
      els.exportCsvBtn.addEventListener('click', exportCSV);
      els.exportSungrazerBtn.addEventListener('click', exportSungrazer);
      els.exportAllFlaggedBtn.addEventListener('click', ()=>downloadText('all_flagged_comets.json',
        JSON.stringify(allFlaggedAcross.map(c=>({
          id: c.id, telescope: c.telescope, label: c.label, score: c.score,
          timestamp: c.timestamp, cx: c.cx, cy: c.cy, report: c.reportName,
          paths: { original:c.originalPath, annotated_full:c.annotatedFull, crop:c.cropPath, gif_ann:c.gifAnn, gif_crop:c.gifCrop, mp4:c.mp4 }
        })), null, 2)));
      els.reloadDbBtn.addEventListener('click', loadNasaCatalog);
      document.getElementById('btnLoadMore').addEventListener('click', () => {
        visibleCount += PAGE_SIZE;
        renderCandidates();
        document.getElementById('btnLoadMore').scrollIntoView({behavior:'smooth', block:'center'});
      });

      populateReportSelect();
      loadNasaCatalog();
      updateLiveStamps();
      startCountdown(300);
    });
  </script>
</body>
</html>
