<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>SOHO Comet Hunter – Professional Dashboard</title>
  <link rel="icon" href="https://soho.nascom.nasa.gov/favicon.ico">
  <style>
    :root{
      --bg-primary:#05080f; --bg-elev:#0c1221; --bg-card:#10172a;
      --border:#1b2640; --border-strong:#2a3a60;
      --text-primary:#e9eef7; --text-secondary:#a6b3cf; --text-tertiary:#7c8db1;
      --accent:#4a9eff; --accent-2:#2f80ff; --accent-glow:rgba(74,158,255,.20);
      --success:#22c55e; --danger:#ef4444; --warn:#fbbf24;
      --radius:14px; --radius-sm:10px;
      --shadow:0 8px 28px rgba(0,0,0,.45); --shadow-sm:0 6px 16px rgba(0,0,0,.35);
      --font-ui:-apple-system,BlinkMacSystemFont,'SF Pro Text','Segoe UI',Roboto,Inter,Helvetica,Arial,sans-serif;
      --mono:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0; font-family:var(--font-ui); color:var(--text-primary);
      background:
        radial-gradient(1200px 600px at 50% -200px,rgba(42,60,120,.35),transparent 70%),
        linear-gradient(180deg,#060B15 0%, #060913 100%);
      background-color:var(--bg-primary);
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    .appbar{position:sticky;top:0;z-index:1000;backdrop-filter:saturate(140%) blur(14px);
      background:color-mix(in oklab, var(--bg-elev) 90%, transparent);
      border-bottom:1px solid var(--border);}
    .container{max-width:1320px;margin:0 auto;padding:0 16px}
    .appbar-row{display:flex;align-items:center;justify-content:space-between;min-height:60px;gap:12px;padding:10px 0;}
    .brand-title h1{margin:0;font-size:20px;font-weight:800;letter-spacing:-.2px;
      background:linear-gradient(135deg,#fff 0%,#bfe0ff 45%,#84b8ff 95%);
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
    .brand-sub{margin:0;font-size:12px;color:var(--text-tertiary)}
    .appbar-actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .status{display:flex;align-items:center;gap:8px;padding:6px 12px;border-radius:999px;font-weight:700;font-size:12px;
      color:#0f2a18;background:linear-gradient(180deg,#A6F4C5,#59d68a)}
    .dot{width:8px;height:8px;border-radius:999px;background:#16a34a;box-shadow:0 0 10px #22c55e}
    .btn{appearance:none;border:1px solid var(--border-strong);
      background:linear-gradient(180deg, var(--bg-card), #0b1326);color:var(--text-primary);
      border-radius:12px;padding:9px 14px;font-weight:700;font-size:13px;cursor:pointer;
      transition:.15s;border-color:var(--border-strong)}
    .btn:hover{border-color:var(--accent);box-shadow:0 0 0 4px var(--accent-glow)}
    .btn.primary{border-color:transparent;background:linear-gradient(180deg,var(--accent),var(--accent-2));color:#fff}
    .btn.sm{padding:8px 12px;font-size:12px;border-radius:10px}
    .toolbar{border-top:1px solid var(--border);border-bottom:1px solid var(--border);
      background:color-mix(in oklab, var(--bg-elev) 88%, transparent);}
    .toolbar-grid{display:grid;gap:12px;padding:12px 0;grid-template-columns:repeat(12,1fr);align-items:end}
    .group{display:flex;flex-direction:column;gap:6px}
    .label{font-size:11px;text-transform:uppercase;letter-spacing:.08em;color:var(--text-tertiary);font-weight:800}
    .select,.input{
      width:100%;height:44px;padding:0 14px;border-radius:12px;border:1.5px solid var(--border-strong);
      background:#0b1326;color:var(--text-primary);font-size:15px;appearance:none;
      text-align:left; text-align-last:left;
      box-shadow:inset 0 1px 0 rgba(255,255,255,.03);
    }
    .select:focus,.input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 4px var(--accent-glow)}
    .filters{display:flex;gap:8px;flex-wrap:wrap;align-items:center;padding-top:6px}
    .chip{display:inline-flex;align-items:center;gap:8px;height:36px;padding:0 12px;border-radius:999px;border:1px solid var(--border-strong);
      background:var(--bg-card);font-weight:700;font-size:12px;color:var(--text-secondary);cursor:pointer}
    .chip input{accent-color:var(--accent);width:16px;height:16px}
    .export-row{display:flex;align-items:center;gap:8px;white-space:nowrap;overflow:auto;padding-bottom:2px}
    .divider{width:1px;height:24px;background:var(--border-strong);flex:0 0 auto;opacity:.8}
    .col-4{grid-column:span 4} .col-3{grid-column:span 3} .col-5{grid-column:span 5} .col-12{grid-column:1/-1}
    @media (max-width:1200px){.col-4,.col-3,.col-5{grid-column:span 6}}
    @media (max-width:820px){.toolbar-grid{grid-template-columns:repeat(6,1fr)} .col-4,.col-3,.col-5{grid-column:1/-1}}
    @media (max-width:480px){.toolbar-grid{grid-template-columns:repeat(4,1fr)}}
    main{padding:18px 0}
    .stats{display:grid;gap:12px;grid-template-columns:repeat(6,1fr)}
    .stat{border:1px solid var(--border);background:linear-gradient(180deg,var(--bg-card),#0b1326);
      border-radius:var(--radius);padding:14px;box-shadow:var(--shadow-sm)}
    .stat .k{font-size:11px;text-transform:uppercase;color:var(--text-tertiary);letter-spacing:.08em;font-weight:800}
    .stat .v{margin-top:6px;font-size:28px;font-weight:900;background:linear-gradient(135deg,#fff,#a9d1ff);
      -webkit-background-clip:text;-webkit-text-fill-color:transparent}
    @media (max-width:1200px){.stats{grid-template-columns:repeat(3,1fr)}}
    @media (max-width:820px){.stats{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:480px){.stats{grid-template-columns:1fr}}
    .live{display:grid;gap:12px;margin-top:14px;grid-template-columns:repeat(3,1fr)}
    @media (max-width:1200px){.live{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:820px){.live{grid-template-columns:1fr}}
    .feed{border:1px solid var(--border);background:linear-gradient(180deg,var(--bg-card),#0b1326);
      border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow-sm)}
    .feed-h{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--border);
      background:linear-gradient(180deg, color-mix(in oklab, var(--accent) 10%, transparent), transparent)}
    .badge{font-size:11px;padding:4px 10px;border-radius:999px;background:linear-gradient(180deg,var(--accent),var(--accent-2));color:#fff;font-weight:800}
    .feed-b{aspect-ratio:1;background:#000;display:flex;align-items:center;justify-content:center}
    .feed-b img,.feed-b video{width:100%;height:100%;object-fit:contain}
    .feed.gif-hidden .feed-b{display:none}
    .feed-f{display:flex;justify-content:space-between;padding:10px 14px;color:var(--text-secondary);font-size:12px;background:rgba(255,255,255,.03)}
    .section-row{margin-top:18px;display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .h2{font-size:20px;font-weight:900;letter-spacing:-.2px;background:linear-gradient(135deg,#fff,#c6e0ff);
      -webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .grid{display:grid;gap:12px;margin-top:10px;grid-template-columns:repeat(12,1fr)}
    .card{grid-column:span 4;border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;
      background:linear-gradient(180deg,var(--bg-card),#0b1326);box-shadow:var(--shadow-sm);transition:.15s;cursor:pointer}
    .card:hover{transform:translateY(-2px);box-shadow:0 10px 30px rgba(0,0,0,.45);border-color:var(--accent)}
    @media (max-width:1200px){.card{grid-column:span 6}} @media (max-width:820px){.card{grid-column:span 12}}
  </style>
</head>
<body>
  <header class="appbar">
    <div class="container">
      <div class="appbar-row">
        <div class="brand-title">
          <h1>SOHO Comet Hunter</h1>
          <p class="brand-sub">Professional Dashboard</p>
        </div>
        <div class="appbar-actions">
          <div class="status">
            <div class="dot"></div>
            Operational
          </div>
          <button class="btn primary" id="refreshBtn">Refresh All</button>
        </div>
      </div>
    </div>
  </header>

  <div class="toolbar">
    <div class="container">
      <div class="toolbar-grid">
        <div class="group col-3">
          <label class="label">Report</label>
          <select class="select" id="reportSelect"><option value="">Select Report...</option></select>
        </div>
        <div class="group col-3">
          <label class="label">Candidate</label>
          <select class="select" id="candidateSelect"><option value="">All Candidates</option></select>
        </div>
        <div class="group col-3">
          <label class="label">NASA Comets</label>
          <select class="select" id="cometSelect"><option value="">All Comets</option></select>
        </div>
        <div class="group col-3">
          <label class="label">Filters</label>
          <div class="filters">
            <label class="chip"><input type="checkbox" id="filterC2" checked> C2</label>
            <label class="chip"><input type="checkbox" id="filterC3" checked> C3</label>
            <label class="chip"><input type="checkbox" id="filterCCOR1" checked> CCOR-1</label>
            <label class="chip"><input type="checkbox" id="filterComet"> Comet</label>
            <label class="chip"><input type="checkbox" id="filterMarked"> Marked</label>
            <label class="chip"><input type="checkbox" id="showNotComet"> Show Not Comet</label>
            <label class="chip"><input type="checkbox" id="filterScore51"> Score >50%</label>
            <label class="chip"><input type="checkbox" id="highlightOfficial" checked> Highlight Official</label>
          </div>
        </div>
        <div class="group col-12">
          <div class="export-row">
            <button class="btn sm" id="exportTxtBtn">Export TXT</button>
            <div class="divider"></div>
            <button class="btn sm" id="exportCsvBtn">Export CSV</button>
            <div class="divider"></div>
            <button class="btn sm" id="exportSungrazerBtn">Export Sungrazer</button>
            <div class="divider"></div>
            <button class="btn sm" id="exportAllFlaggedBtn">Export All Flagged</button>
            <label class="chip"><input type="checkbox" id="exportMarkedOnly"> Marked Only</label>
            <select id="sungrazerObject" class="select sm">
              <option>Kreutz</option><option>Meyer</option><option>Marsden</option><option>Kracht</option><option>Non-group</option>
            </select>
            <select id="sungrazerInstrument" class="select sm">
              <option>C2</option><option>C3</option><option>CCOR1</option>
            </select>
          </div>
        </div>
      </div>
    </div>
  </div>

  <main>
    <div class="container">
      <div class="stats">
        <div class="stat"><div class="k">Candidates</div><div class="v" id="statCandidates">0</div></div>
        <div class="stat"><div class="k">AI Comets</div><div class="v" id="statAIComets">0</div></div>
        <div class="stat"><div class="k">Marked</div><div class="v" id="statMarked">0</div></div>
        <div class="stat"><div class="k">Official</div><div class="v" id="statOfficial">0</div></div>
        <div class="stat"><div class="k">Next Update</div><div class="v" id="countdown">5:00</div></div>
        <div class="stat"><div class="k">Report Status</div><div class="v" id="reportStatus">--</div></div>
      </div>

      <!-- ==================== LIVE FEEDS ==================== -->
      <div class="live">
        <!-- C2 -->
        <div class="feed" id="feedC2">
          <div class="feed-h"><span class="badge">LIVE</span><button class="btn sm" id="toggleC2">Hide GIF</button></div>
          <div class="feed-b"><img id="c2LiveGif" data-src="https://soho.nascom.nasa.gov/data/LATEST/current_c2.gif"></div>
          <div class="feed-f"><span>SOHO LASCO C2</span><span id="c2Timestamp">--:-- UTC</span></div>
        </div>

        <!-- C3 -->
        <div class="feed" id="feedC3">
          <div class="feed-h"><span class="badge">LIVE</span><button class="btn sm" id="toggleC3">Hide GIF</button></div>
          <div class="feed-b"><img id="c3LiveGif" data-src="https://soho.nascom.nasa.gov/data/LATEST/current_c3.gif"></div>
          <div class="feed-f"><span>SOHO LASCO C3</span><span id="c3Timestamp">--:-- UTC</span></div>
        </div>

        <!-- CCOR-1 -->
        <div class="feed" id="feedCCOR1">
          <div class="feed-h"><span class="badge">LIVE</span><button class="btn sm" id="toggleCCOR1">Hide Animation</button></div>
          <div class="feed-b">
            <video id="ccor1LiveVideo" data-src="https://ccor.nrl.navy.mil/ccor_realtime/CCOR1_realtime_RunDiff.mp4"
                   autoplay loop muted playsinline></video>
          </div>
          <div class="feed-f"><span>GOES-19 CCOR-1</span><span id="ccor1Timestamp">--:-- UTC</span></div>
        </div>
      </div>

      <div class="section-row">
        <h2 class="h2">Candidates <span id="filterCount">(0)</span></h2>
        <button class="btn sm" id="btnLoadMore">Load More</button>
      </div>
      <div class="grid" id="candidatesGrid"></div>
      <div id="emptyState" style="text-align:center;color:var(--text-tertiary);padding:40px 0;">No candidates match filters.</div>

      <div class="section-row">
        <h2 class="h2">NASA Comet Database</h2>
        <button class="btn sm" id="reloadDbBtn">Reload DB</button>
      </div>
      <table style="width:100%;border-collapse:collapse;">
        <thead style="background:var(--bg-elev);"><tr><th>ID</th><th>Date</th><th>Instrument</th><th>Group</th></tr></thead>
        <tbody id="dbTableBody"></tbody>
      </table>
      <p id="dbStatus" style="color:var(--text-tertiary);font-size:12px;margin-top:8px;">Loading...</p>
    </div>
  </main>

  <script>
    /* ======================= GLOBALS ======================= */
    const els = {};
    let reports = [], candidates = [], nasaComets = [], allFlaggedAcross = [];
    let visibleCount = 30, PAGE_SIZE = 30, filterTimer = null;

    /* ======================= UTILS ======================= */
    const normPath = p => p.startsWith('/') ? p : `/${p}`;
    const fetchJson = async url => { const r = await fetch(url); if (!r.ok) throw new Error(`HTTP ${r.status}`); return r.json(); };
    const downloadText = (name, txt) => {
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([txt], {type:'text/plain;charset=utf-8'}));
      a.download = name; a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href),1000);
    };
    const sungrazerLinesFromPositions = c => c.positions.map(p => {
      const t = p.time_utc.replace(/[-:TZ]/g,'').slice(0,12);
      return `${t} ${Math.round(p.x)} ${Math.round(p.y)}`;
    });

    /* ======================= DATA LOADING ======================= */
    async function populateReportSelect() {
      try {
        reports = await fetchJson('/detections/reports.json');
        els.reportSelect.innerHTML = '<option value="">Select Report...</option>' +
          reports.reports.map(r=>`<option value="${r}">${r.replace('candidates_','').replace('.json','')}</option>`).join('');
      } catch(e){ console.error(e); }
    }

    async function loadReport(name){
      if(!name) return;
      try{
        candidates = await fetchJson(`/detections/${name}`);
        candidates.forEach(c=>{
          c.id = `${c.detector}_${c.series_mid_frame.replace(/\W+/g,'_')}_${c.track_index}`;
          c.telescope = c.detector;
          c.label = c.ai_label || 'unknown';
          c.score = c.ai_score || 0;
          c.timestamp = c.positions?.[Math.floor(c.positions.length/2)]?.time_utc || '';
          c.cx = c.positions?.reduce((s,p)=>s+p.x,0)/c.positions?.length || null;
          c.cy = c.positions?.reduce((s,p)=>s+p.y,0)/c.positions?.length || null;
          c.bbox = c.bbox || null;
          c.originalPath = c.original_mid_path;
          c.annotatedFull = c.annotated_path;
          c.cropPath = c.crop_path;
          c.gifCrop = c.crop_gif_path;
          c.gifAnn = c.annotated_gif_path || '';
          c.mp4 = c.crop_mp4_path || '';
          c.reportName = name;
          c.marked = false;
        });
        crossCheckCandidates(); scheduleFilter();
        els.reportStatus.textContent = `Loaded ${candidates.length} candidates`;
      }catch(e){ console.error(e); els.reportStatus.textContent='Load failed'; }
    }

    function crossCheckCandidates(){
      candidates.forEach(c=>{
        c.official = nasaComets.some(com=>{
          const dt = Math.abs(new Date(c.timestamp)-new Date(com.date));
          return dt<3600000 && com.instrument===c.telescope;
        });
      });
    }

    async function loadNasaCatalog(){
      els.dbStatus.textContent='Loading...';
      try{
        const data = await fetchJson('https://sungrazer.nrl.navy.mil/api/comets?limit=500');
        nasaComets = data.comets.map(com=>({id:com.id,date:com.discovery_date,instrument:com.instrument,group:com.group}));
        els.dbTableBody.innerHTML = nasaComets.map(com=>`<tr><td>${com.id}</td><td>${com.date}</td><td>${com.instrument}</td><td>${com.group}</td></tr>`).join('');
        els.dbStatus.textContent=`Loaded ${nasaComets.length} comets`;
        crossCheckCandidates(); scheduleFilter();
      }catch(e){ console.error(e); els.dbStatus.textContent='Load failed'; }
    }

    /* ======================= FILTER / RENDER ======================= */
    function scheduleFilter(){ clearTimeout(filterTimer); filterTimer=setTimeout(renderCandidates,100); }

    function shouldShow(c){
      if(!els.showNotComet.checked && c.label!=='comet') return false;
      if(els.filterScore51.checked && c.score<0.51) return false;
      if(els.filterComet.checked && c.label!=='comet') return false;
      if(els.filterMarked.checked && !c.marked) return false;
      const tel = c.telescope.toUpperCase();
      if(els.filterC2.checked && tel.includes('C2')) return true;
      if(els.filterC3.checked && tel.includes('C3')) return true;
      if(els.filterCCOR1.checked && tel.includes('CCOR')) return true;
      return false;
    }

    function renderCandidates(){
      const filtered = candidates.filter(shouldShow).slice(0,visibleCount);
      els.filterCount.textContent=`(${filtered.length}/${candidates.length})`;
      els.emptyState.style.display = filtered.length?'none':'block';
      els.candidatesGrid.innerHTML = filtered.map(c=>{
        const highlight = els.highlightOfficial.checked && c.official ? 'border-color:var(--success);' : '';
        return `<div class="card" style="${highlight}" onclick="markCandidate('${c.id}')">
          <img src="${normPath(c.cropPath)}" style="width:100%;aspect-ratio:1;object-fit:contain;background:#000;">
          <div style="padding:10px 12px;">
            <div style="font-weight:700;">${c.telescope} #${c.track_index}</div>
            <div style="color:var(--text-secondary);font-size:12px;">Score: ${(c.score*100).toFixed(0)}% • ${c.timestamp}</div>
          </div></div>`;
      }).join('');
      updateStats();
    }

    function markCandidate(id){
      const c = candidates.find(x=>x.id===id);
      if(c) c.marked = !c.marked;
      allFlaggedAcross = [...new Set([...allFlaggedAcross, ...(c.marked?[c]:[])])].filter(x=>x.marked);
      renderCandidates();
    }

    function updateStats(){
      els.statCandidates.textContent = candidates.length;
      els.statAIComets.textContent = candidates.filter(c=>c.label==='comet').length;
      els.statMarked.textContent = candidates.filter(c=>c.marked).length;
      els.statOfficial.textContent = candidates.filter(c=>c.official).length;
    }

    /* ======================= EXPORTS ======================= */
    function exportTXT(){
      const list = candidates.filter(c=>!els.exportMarkedOnly.checked||c.marked);
      let txt=''; list.forEach(c=>{
        txt+=`${c.id}\n${c.timestamp}\n${c.telescope}\nScore: ${c.score}\nPositions:\n`;
        c.positions.forEach(p=>txt+=`  ${p.time_utc} x:${p.x} y:${p.y}\n`); txt+='\n';
      });
      downloadText('candidates.txt',txt);
    }
    function exportCSV(){
      let csv='ID,Telescope,Score,Timestamp,CX,CY\n';
      const list = candidates.filter(c=>!els.exportMarkedOnly.checked||c.marked);
      list.forEach(c=>csv+=`${c.id},${c.telescope},${c.score},${c.timestamp},${c.cx},${c.cy}\n`);
      downloadText('candidates.csv',csv);
    }
    function exportSungrazer(){
      const list = candidates.filter(c=>!els.exportMarkedOnly.checked||c.marked);
      let txt=''; list.forEach(c=>{
        txt+=`== ${c.id} ==\n${els.sungrazerObject.value}\n${c.telescope}\nFirstDate: ${c.timestamp.slice(0,10).replace(/-/g,'')}\nFrames (time_utc, x, y):\n`;
        sungrazerLinesFromPositions(c).forEach(L=>{
          const [t,x,y]=L.split(' ');
          const iso = c.timestamp||t;
          const ft = iso.length>8?new Date(iso).toISOString().replace('T',' ').slice(0,19):iso;
          txt+=`  ${ft}, ${x}, ${y}\n`;
        });
        txt+='\n';
      });
      downloadText('sungrazer_batch.txt',txt);
    }

    /* ======================= LIVE GIF/VIDEO TOGGLE ======================= */
    function toggleLiveGif(feedId, btnId, mediaId, tsId){
      const feed=document.getElementById(feedId), btn=document.getElementById(btnId),
            media=document.getElementById(mediaId);
      const hidden = feed.classList.toggle('gif-hidden');
      const type = mediaId.toLowerCase().includes('video')?'Animation':'GIF';
      btn.textContent = hidden?`Show ${type}`:`Hide ${type}`;
      if(!hidden && !media.src) media.src = media.dataset.src;
    }

    /* ======================= TIME ======================= */
    function updateLiveStamps(){
      const t=new Date(), hh=String(t.getUTCHours()).padStart(2,'0'), mm=String(t.getUTCMinutes()).padStart(2,'0');
      els.c2Timestamp.textContent = `${hh}:${mm} UTC`;
      els.c3Timestamp.textContent = `${hh}:${mm} UTC`;
      els.ccor1Timestamp.textContent = `${hh}:${mm} UTC`;
    }
    function startCountdown(sec=300){
      let s=sec;
      const tick=()=>{ const m=String(Math.floor(s/60)).padStart(1,'0'), r=String(s%60).padStart(2,'0');
        els.countdown.textContent=`${m}:${r}`; s<=0?(refreshAll(),s=sec):s--; };
      tick(); setInterval(tick,1000);
    }
    function refreshAll(){ const sel=els.reportSelect.value; if(sel) loadReport(sel); updateLiveStamps(); }

    /* ======================= DOM READY ======================= */
    document.addEventListener('DOMContentLoaded',()=>{

      /* ---- element cache ---- */
      Object.assign(els,{
        reportSelect:document.getElementById('reportSelect'),
        candidateSelect:document.getElementById('candidateSelect'),
        cometSelect:document.getElementById('cometSelect'),
        refreshBtn:document.getElementById('refreshBtn'),
        countdown:document.getElementById('countdown'),
        exportTxtBtn:document.getElementById('exportTxtBtn'),
        exportCsvBtn:document.getElementById('exportCsvBtn'),
        exportSungrazerBtn:document.getElementById('exportSungrazerBtn'),
        exportAllFlaggedBtn:document.getElementById('exportAllFlaggedBtn'),
        exportMarkedOnly:document.getElementById('exportMarkedOnly'),
        sungrazerObject:document.getElementById('sungrazerObject'),
        sungrazerInstrument:document.getElementById('sungrazerInstrument'),
        filterC2:document.getElementById('filterC2'),
        filterC3:document.getElementById('filterC3'),
        filterCCOR1:document.getElementById('filterCCOR1'),
        filterComet:document.getElementById('filterComet'),
        filterMarked:document.getElementById('filterMarked'),
        showNotComet:document.getElementById('showNotComet'),
        highlightOfficial:document.getElementById('highlightOfficial'),
        filterScore51:document.getElementById('filterScore51'),
        candidatesGrid:document.getElementById('candidatesGrid'),
        filterCount:document.getElementById('filterCount'),
        emptyState:document.getElementById('emptyState'),
        c2LiveGif:document.getElementById('c2LiveGif'),
        c3LiveGif:document.getElementById('c3LiveGif'),
        ccor1LiveVideo:document.getElementById('ccor1LiveVideo'),
        c2Timestamp:document.getElementById('c2Timestamp'),
        c3Timestamp:document.getElementById('c3Timestamp'),
        ccor1Timestamp:document.getElementById('ccor1Timestamp'),
        reloadDbBtn:document.getElementById('reloadDbBtn'),
        dbStatus:document.getElementById('dbStatus'),
        dbTableBody:document.getElementById('dbTableBody'),
        reportStatus:document.getElementById('reportStatus')
      });

      /* ---- live-feed toggles ---- */
      document.getElementById('toggleC2').addEventListener('click',()=>toggleLiveGif('feedC2','toggleC2','c2LiveGif','c2Timestamp'));
      document.getElementById('toggleC3').addEventListener('click',()=>toggleLiveGif('feedC3','toggleC3','c3LiveGif','c3Timestamp'));
      document.getElementById('toggleCCOR1').addEventListener('click',()=>toggleLiveGif('feedCCOR1','toggleCCOR1','ccor1LiveVideo','ccor1Timestamp'));

      /* ---- UI actions ---- */
      els.refreshBtn.addEventListener('click',refreshAll);
      els.reportSelect.addEventListener('change',e=>loadReport(e.target.value));
      els.candidateSelect.addEventListener('change',scheduleFilter);
      els.cometSelect.addEventListener('change',()=>{crossCheckCandidates();scheduleFilter();});
      ['filterC2','filterC3','filterCCOR1','filterComet','filterMarked','showNotComet','highlightOfficial','filterScore51']
        .forEach(id=>els[id]?.addEventListener('change',scheduleFilter));
      els.exportTxtBtn.addEventListener('click',exportTXT);
      els.exportCsvBtn.addEventListener('click',exportCSV);
      els.exportSungrazerBtn.addEventListener('click',exportSungrazer);
      els.exportAllFlaggedBtn.addEventListener('click',()=>downloadText('all_flagged_comets.json',
        JSON.stringify(allFlaggedAcross.map(c=>({
          id:c.id,telescope:c.telescope,label:c.label,score:c.score,
          timestamp:c.timestamp,cx:c.cx,cy:c.cy,report:c.reportName,
          paths:{original:c.originalPath,annotated_full:c.annotatedFull,crop:c.cropPath,gif_ann:c.gifAnn,gif_crop:c.gifCrop,mp4:c.mp4}
        })),null,2)));
      els.reloadDbBtn.addEventListener('click',loadNasaCatalog);
      document.getElementById('btnLoadMore').addEventListener('click',()=>{
        visibleCount+=PAGE_SIZE; renderCandidates();
        document.getElementById('btnLoadMore').scrollIntoView({behavior:'smooth',block:'center'});
      });

      /* ---- init ---- */
      populateReportSelect();
      loadNasaCatalog();
      updateLiveStamps();
      startCountdown(300);
    });
  </script>
</body>
</html>
