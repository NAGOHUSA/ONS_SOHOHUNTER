<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>SOHO Comet Hunter – Professional Dashboard</title>
  <link rel="icon" href="https://soho.nascom.nasa.gov/favicon.ico">
  <style>
    :root{
      --bg-primary:#05080f; --bg-elev:#0c1221; --bg-card:#10172a;
      --border:#1b2640; --border-strong:#2a3a60;
      --text-primary:#e9eef7; --text-secondary:#a6b3cf; --text-tertiary:#7c8db1;
      --accent:#4a9eff; --accent-2:#2f80ff; --accent-glow:rgba(74,158,255,.20);
      --success:#22c55e; --danger:#ef4444; --warn:#fbbf24;
      --radius:14px; --radius-sm:10px;
      --shadow:0 8px 28px rgba(0,0,0,.45); --shadow-sm:0 6px 16px rgba(0,0,0,.35);
      --font-ui:-apple-system,BlinkMacSystemFont,'SF Pro Text','Segoe UI',Roboto,Inter,Helvetica,Arial,sans-serif;
      --mono:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0; font-family:var(--font-ui); color:var(--text-primary);
      background:
        radial-gradient(1200px 600px at 50% -200px,rgba(42,60,120,.35),transparent 70%),
        linear-gradient(180deg,#060B15 0%, #060913 100%);
      background-color:var(--bg-primary);
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }

    /* App bar */
    .appbar{position:sticky;top:0;z-index:1000;backdrop-filter:saturate(140%) blur(14px);
      background:color-mix(in oklab, var(--bg-elev) 90%, transparent);
      border-bottom:1px solid var(--border);}
    .container{max-width:1320px;margin:0 auto;padding:0 16px}
    .appbar-row{display:flex;align-items:center;justify-content:space-between;min-height:60px;gap:12px;padding:10px 0;}
    .brand-title h1{margin:0;font-size:20px;font-weight:800;letter-spacing:-.2px;
      background:linear-gradient(135deg,#fff 0%,#bfe0ff 45%,#84b8ff 95%);
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
    .brand-sub{margin:0;font-size:12px;color:var(--text-tertiary)}

    .appbar-actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .status{display:flex;align-items:center;gap:8px;padding:6px 12px;border-radius:999px;font-weight:700;font-size:12px;
      color:#0f2a18;background:linear-gradient(180deg,#A6F4C5,#59d68a)}
    .dot{width:8px;height:8px;border-radius:999px;background:#16a34a;box-shadow:0 0 10px #22c55e}
    .btn{appearance:none;border:1px solid var(--border-strong);
      background:linear-gradient(180deg, var(--bg-card), #0b1326);color:var(--text-primary);
      border-radius:12px;padding:9px 14px;font-weight:700;font-size:13px;cursor:pointer;
      transition:.15s;border-color:var(--border-strong)}
    .btn:hover{border-color:var(--accent);box-shadow:0 0 0 4px var(--accent-glow)}
    .btn.primary{border-color:transparent;background:linear-gradient(180deg,var(--accent),var(--accent-2));color:#fff}
    .btn.sm{padding:8px 12px;font-size:12px;border-radius:10px}

    /* Toolbar */
    .toolbar{border-top:1px solid var(--border);border-bottom:1px solid var(--border);
      background:color-mix(in oklab, var(--bg-elev) 88%, transparent);}
    .toolbar-grid{display:grid;gap:12px;padding:12px 0;grid-template-columns:repeat(12,1fr);align-items:end}
    .group{display:flex;flex-direction:column;gap:6px}
    .label{font-size:11px;text-transform:uppercase;letter-spacing:.08em;color:var(--text-tertiary);font-weight:800}

    /* Improved select readability */
    .select,.input{
      width:100%;height:44px;padding:0 14px;border-radius:12px;border:1.5px solid var(--border-strong);
      background:#0b1326;color:var(--text-primary);font-size:15px;appearance:none;
      text-align:left; text-align-last:left;
      box-shadow:inset 0 1px 0 rgba(255,255,255,.03);
    }
    .select:focus,.input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 4px var(--accent-glow)}

    .filters{display:flex;gap:8px;flex-wrap:wrap;align-items:center;padding-top:6px}
    .chip{display:inline-flex;align-items:center;gap:8px;height:36px;padding:0 12px;border-radius:999px;border:1px solid var(--border-strong);
      background:var(--bg-card);font-weight:700;font-size:12px;color:var(--text-secondary);cursor:pointer}
    .chip input{accent-color:var(--accent);width:16px;height:16px}

    /* Export row: one horizontal line (scroll on small screens) */
    .export-row{display:flex;align-items:center;gap:8px;white-space:nowrap;overflow:auto;padding-bottom:2px}
    .divider{width:1px;height:24px;background:var(--border-strong);flex:0 0 auto;opacity:.8}

    .col-4{grid-column:span 4} .col-3{grid-column:span 3} .col-5{grid-column:span 5} .col-12{grid-column:1/-1}
    @media (max-width:1200px){.col-4,.col-3,.col-5{grid-column:span 6}}
    @media (max-width:820px){.toolbar-grid{grid-template-columns:repeat(6,1fr)} .col-4,.col-3,.col-5{grid-column:1/-1}}
    @media (max-width:480px){.toolbar-grid{grid-template-columns:repeat(4,1fr)}}

    /* Content */
    main{padding:18px 0}
    .stats{display:grid;gap:12px;grid-template-columns:repeat(6,1fr)}
    .stat{border:1px solid var(--border);background:linear-gradient(180deg,var(--bg-card),#0b1326);
      border-radius:var(--radius);padding:14px;box-shadow:var(--shadow-sm)}
    .stat .k{font-size:11px;text-transform:uppercase;color:var(--text-tertiary);letter-spacing:.08em;font-weight:800}
    .stat .v{margin-top:6px;font-size:28px;font-weight:900;background:linear-gradient(135deg,#fff,#a9d1ff);
      -webkit-background-clip:text;-webkit-text-fill-color:transparent}
    @media (max-width:1200px){.stats{grid-template-columns:repeat(3,1fr)}}
    @media (max-width:820px){.stats{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:480px){.stats{grid-template-columns:1fr}}

    .live{display:grid;gap:12px;margin-top:14px;grid-template-columns:repeat(2,1fr)}
    @media (max-width:820px){.live{grid-template-columns:1fr}}
    .feed{border:1px solid var(--border);background:linear-gradient(180deg,var(--bg-card),#0b1326);
      border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow-sm)}
    .feed-h{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--border);
      background:linear-gradient(180deg, color-mix(in oklab, var(--accent) 10%, transparent), transparent)}
    .badge{font-size:11px;padding:4px 10px;border-radius:999px;background:linear-gradient(180deg,var(--accent),var(--accent-2));color:#fff;font-weight:800}
    .feed-b{aspect-ratio:1;background:#000;display:flex;align-items:center;justify-content:center}
    .feed-b img{width:100%;height:100%;object-fit:contain}
    .feed-f{display:flex;justify-content:space-between;padding:10px 14px;color:var(--text-secondary);font-size:12px;background:rgba(255,255,255,.03)}

    .section-row{margin-top:18px;display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .h2{font-size:20px;font-weight:900;letter-spacing:-.2px;background:linear-gradient(135deg,#fff,#c6e0ff);
      -webkit-background-clip:text;-webkit-text-fill-color:transparent}

    .grid{display:grid;gap:12px;margin-top:10px;grid-template-columns:repeat(12,1fr)}
    .card{grid-column:span 4;border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;
      background:linear-gradient(180deg,var(--bg-card),#0b1326);box-shadow:var(--shadow-sm);transition:.15s;cursor:pointer}
    .card:hover{transform:translateY(-2px);box-shadow:0 10px 30px rgba(0,0,0,.45);border-color:var(--accent)}
    @media (max-width:1200px){.card{grid-column:span 6}} @media (max-width:820px){.card{grid-column:span 12}}
    .thumb{width:100%;aspect-ratio:16/10;background:#000} .thumb img{width:100%;height:100%;object-fit:contain}
    .gif{max-height:150px;overflow:hidden;border-top:1px solid var(--border);background:#000} .gif img{width:100%}
    .card-b{padding:12px} .row{display:flex;align-items:flex-start;justify-content:space-between;gap:10px}
    .chip-label{font-size:11px;font-weight:900;padding:4px 10px;border-radius:999px;background:rgba(255,255,255,.06);
      border:1px solid var(--border);color:var(--text-secondary)}
    .chip-label.comet{background:linear-gradient(180deg,#2e7d4d,#205f39);color:#e6ffef;border-color:#2b7b4b}
    .chip-label.not_comet{background:linear-gradient(180deg,#3a4258,#2a3144)}
    .chip-label.unknown{background:linear-gradient(180deg,#334155,#2a3448)}
    .chip-label.official{background:linear-gradient(180deg,#fbd365,#f6b21a);color:#1a1605;border-color:#f9ca4e}
    .meta{margin-top:8px;display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:13px;color:var(--text-secondary)}
    .meta .k{font-size:11px;text-transform:uppercase;letter-spacing:.08em;color:var(--text-tertiary);font-weight:800}
    .actions{display:flex;gap:8px;margin-top:10px}

    .empty{padding:28px;text-align:center;color:var(--text-secondary);border:1px dashed var(--border);border-radius:var(--radius);background:rgba(255,255,255,.03)}

    /* Modal */
    .modal{display:none;position:fixed;inset:0;z-index:2000;background:rgba(0,0,0,.72);backdrop-filter:blur(12px);padding:20px;align-items:center;justify-content:center}
    .modal.active{display:flex}
    .modal-card{width:min(980px,100%);max-height:92vh;overflow:auto;background:linear-gradient(180deg,var(--bg-card),#0b1326);
      border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow)}
    .modal-h{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--border);
      background:linear-gradient(180deg, color-mix(in oklab, var(--accent) 10%, transparent), transparent)}
    .modal-b{padding:16px}
    .seg{display:inline-flex;border:1px solid var(--border-strong);border-radius:12px;overflow:hidden}
    .seg button{height:36px;padding:0 12px;border:0;background:transparent;color:var(--text-secondary);font-weight:800;cursor:pointer}
    .seg button.active{background:rgba(255,255,255,.08);color:#fff}
    .bigimg{width:100%;max-height:70vh;object-fit:contain;border-radius:12px;border:1px solid var(--border);background:#000;margin-top:10px}

    /* Credits */
    .credits{margin:32px 0 24px;color:var(--text-tertiary);font-size:13px;text-align:center}
    .credits a{color:#b9d8ff;text-decoration:none} .credits a:hover{color:#fff;text-decoration:underline}
  </style>
</head>
<body>

  <!-- App Bar -->
  <div class="appbar">
    <div class="container">
      <div class="appbar-row">
        <div class="brand-title">
          <h1>SOHO Comet Hunter 3.0</h1>
          <p class="brand-sub">OurNightSky.US - Comet Detection Dashboard in partnership with NagohCreative.com</p>
        </div>
        <div class="appbar-actions">
          <div class="status"><span class="dot"></span>Live</div>
          <a class="btn sm" href="https://github.com/NAGOHUSA/ONS_SOHOHUNTER" target="_blank" rel="noopener">GitHub</a>
          <button class="btn sm" id="refreshBtn">Refresh</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toolbar -->
  <div class="toolbar">
    <div class="container">
      <div class="toolbar-grid">

        <div class="group col-4">
          <div class="label">Detection Report</div>
          <select id="reportSelect" class="select"><option>Loading…</option></select>
        </div>

        <div class="group col-4">
          <div class="label">Candidate</div>
          <select id="candidateSelect" class="select"><option value="">All candidates</option></select>
        </div>

        <div class="group col-4">
          <div class="label">Comet Candidates (flagged)</div>
          <select id="cometSelect" class="select">
            <option value="">All flagged (current report)</option>
          </select>
        </div>

        <div class="group col-12">
          <div class="label">Export</div>
          <div class="export-row">
            <button id="exportTxtBtn" class="btn sm">TXT</button>
            <div class="divider"></div>
            <button id="exportCsvBtn" class="btn sm">CSV</button>
            <div class="divider"></div>
            <button id="exportSungrazerBtn" class="btn sm primary">Sungrazer</button>
            <div class="divider"></div>
            <label class="chip"><input type="checkbox" id="exportMarkedOnly">Marked Only</label>
            <div class="divider"></div>
            <input id="sungrazerObject" class="input" placeholder="Object / Stream (e.g., Kreutz Companion)" style="max-width:320px">
            <select id="sungrazerInstrument" class="select" style="max-width:180px">
              <option value="C2">C2</option>
              <option value="C3">C3</option>
              <option value="auto" selected>Auto by candidate</option>
            </select>
            <div class="divider"></div>
            <button id="exportAllFlaggedBtn" class="btn sm">Export All-Flagged JSON</button>

            <div style="margin-left:auto;display:flex;align-items:center;gap:10px;padding-left:8px">
              <span style="font-size:12px;color:var(--text-secondary)">Next update in</span>
              <span id="countdown" style="font:700 13px var(--mono);color:#bfe0ff">5:00</span>
            </div>
          </div>
        </div>

        <div class="group col-12">
          <div class="filters">
            <label class="chip"><input type="checkbox" id="filterC2">C2</label>
            <label class="chip"><input type="checkbox" id="filterC3">C3</label>
            <label class="chip"><input type="checkbox" id="filterComet">AI Comet Only</label>
            <label class="chip"><input type="checkbox" id="filterMarked">Marked Only</label>
            <label class="chip"><input type="checkbox" id="showNotComet">Show non-comets</label>
            <label class="chip"><input type="checkbox" id="highlightOfficial" checked>Highlight Official</label>
          </div>
        </div>

      </div>
    </div>
  </div>

  <main>
    <div class="container">

      <!-- Stats -->
      <div class="stats">
        <div class="stat"><div class="k">Total</div><div id="statTotal" class="v">0</div></div>
        <div class="stat"><div class="k">AI Comets</div><div id="statComets" class="v">0</div></div>
        <div class="stat"><div class="k">C2</div><div id="statC2" class="v">0</div></div>
        <div class="stat"><div class="k">C3</div><div id="statC3" class="v">0</div></div>
        <div class="stat"><div class="k">Marked</div><div id="statMarked" class="v">0</div></div>
        <div class="stat"><div class="k">Official</div><div id="statOfficial" class="v">0</div></div>
      </div>

      <!-- Live feeds -->
      <div class="live">
        <div class="feed">
          <div class="feed-h">
            <div><strong>LASCO C2</strong> <span class="badge">LIVE</span></div>
            <a class="btn sm" href="https://soho.nascom.nasa.gov/data/LATEST/current_c2.gif" target="_blank" rel="noopener">Open</a>
          </div>
          <div class="feed-b"><img id="c2LiveGif" src="https://soho.nascom.nasa.gov/data/LATEST/current_c2.gif" alt="C2 Live"></div>
          <div class="feed-f"><span>Last Updated</span><span id="c2Timestamp">--:--</span></div>
        </div>
        <div class="feed">
          <div class="feed-h">
            <div><strong>LASCO C3</strong> <span class="badge">LIVE</span></div>
            <a class="btn sm" href="https://soho.nascom.nasa.gov/data/LATEST/current_c3.gif" target="_blank" rel="noopener">Open</a>
          </div>
          <div class="feed-b"><img id="c3LiveGif" src="https://soho.nascom.nasa.gov/data/LATEST/current_c3.gif" alt="C3 Live"></div>
          <div class="feed-f"><span>Last Updated</span><span id="c3Timestamp">--:--</span></div>
        </div>
      </div>

      <!-- Candidates -->
      <div class="section-row">
        <div class="h2">Detection Candidates</div>
        <div id="filterCount" class="label" style="text-transform:none"></div>
      </div>

      <div id="candidatesGrid" class="grid"></div>
      <div id="emptyState" class="empty" style="display:none">No candidates match filters</div>

      <!-- NASA / Sungrazer table -->
      <div class="section-row" style="margin-top:22px">
        <div class="h2">NASA / Sungrazer Catalogue (recent)</div>
        <button id="reloadDbBtn" class="btn sm">Reload</button>
      </div>
      <div id="dbStatus" class="label" style="text-transform:none;margin:6px 0 10px">Not loaded</div>
      <div style="overflow:auto;border:1px solid var(--border);border-radius:var(--radius);background:var(--bg-card);box-shadow:var(--shadow-sm)">
        <table style="width:100%;border-collapse:collapse;font-size:13px">
          <thead>
            <tr style="background:rgba(255,255,255,.04)">
              <th style="text-align:left;padding:10px 12px;border-bottom:1px solid var(--border)">Date</th>
              <th style="text-align:left;padding:10px 12px;border-bottom:1px solid var(--border)">Time</th>
              <th style="text-align:left;padding:10px 12px;border-bottom:1px solid var(--border)">X</th>
              <th style="text-align:left;padding:10px 12px;border-bottom:1px solid var(--border)">Y</th>
              <th style="text-align:left;padding:10px 12px;border-bottom:1px solid var(--border)">Inst</th>
              <th style="text-align:left;padding:10px 12px;border-bottom:1px solid var(--border)">Notes</th>
            </tr>
          </thead>
          <tbody id="dbTableBody"></tbody>
        </table>
      </div>

      <!-- Credits -->
      <div class="credits">
        Website designed & managed by
        <a href="https://nagohcreative.com" target="_blank" rel="noopener">NagohCreative.com</a>
        in partnership with
        <a href="https://ournightsky.us" target="_blank" rel="noopener">OurNightSky.US</a>
      </div>
    </div>
  </main>

  <!-- Modal -->
  <div class="modal" id="candidateModal">
    <div class="modal-card">
      <div class="modal-h">
        <div class="h2" style="font-size:18px" id="modalTitle">Candidate Details</div>
        <button class="btn sm" onclick="closeModal()">Close</button>
      </div>
      <div class="modal-b" id="modalBody"></div>
    </div>
  </div>

  <script>
/* ---------------- CONFIG ---------------- */
const CONFIG = {
  repo: 'NAGOHUSA/ONS_SOHOHUNTER',
  ref:  'main',                 // use latest branch, not pinned SHA
  folder: 'detections'
};
const GITHUB_API = `https://api.github.com/repos/${CONFIG.repo}/contents/${CONFIG.folder}?ref=${CONFIG.ref}`;
const NASA_DB_URL = 'https://comet.nrl.navy.mil/nrlsoho/cometdb.txt';
const MAX_REPORTS_TO_SCAN = 60; // cap for “All flagged across reports”

/* -------- RAW URL helper bound to current ref -------- */
const RAW_URL = (path) => {
  if (!path) return '';
  let p = String(path).trim().replace(/^\.?\/*/, '');
  if (p.startsWith('http')) return p;
  // If caller passed a path already rooted at detections/, avoid duplicating
  if (p.startsWith(`${CONFIG.folder}/`)) {
    return `https://raw.githubusercontent.com/${CONFIG.repo}/${CONFIG.ref}/${p}`;
  }
  return `https://raw.githubusercontent.com/${CONFIG.repo}/${CONFIG.ref}/${CONFIG.folder}/${p}`;
};

/* -------- STATE -------- */
let allCandidates = [];              // current report
let filteredCandidates = [];
let markedIds = new Set();
let nasaCatalog = [];
let allFlaggedAcross = [];           // merged: flagged from ALL reports
let reportNames = [];                // all report json filenames

/* -------- ELEMENTS -------- */
const els = {
  reportSelect: document.getElementById('reportSelect'),
  candidateSelect: document.getElementById('candidateSelect'),
  cometSelect: document.getElementById('cometSelect'),
  refreshBtn: document.getElementById('refreshBtn'),
  countdown: document.getElementById('countdown'),

  exportTxtBtn: document.getElementById('exportTxtBtn'),
  exportCsvBtn: document.getElementById('exportCsvBtn'),
  exportSungrazerBtn: document.getElementById('exportSungrazerBtn'),
  exportAllFlaggedBtn: document.getElementById('exportAllFlaggedBtn'),
  exportMarkedOnly: document.getElementById('exportMarkedOnly'),
  sungrazerObject: document.getElementById('sungrazerObject'),
  sungrazerInstrument: document.getElementById('sungrazerInstrument'),

  filterC2: document.getElementById('filterC2'),
  filterC3: document.getElementById('filterC3'),
  filterComet: document.getElementById('filterComet'),
  filterMarked: document.getElementById('filterMarked'),
  showNotComet: document.getElementById('showNotComet'),
  highlightOfficial: document.getElementById('highlightOfficial'),

  candidatesGrid: document.getElementById('candidatesGrid'),
  filterCount: document.getElementById('filterCount'),
  emptyState: document.getElementById('emptyState'),

  c2LiveGif: document.getElementById('c2LiveGif'),
  c3LiveGif: document.getElementById('c3LiveGif'),
  c2Timestamp: document.getElementById('c2Timestamp'),
  c3Timestamp: document.getElementById('c3Timestamp'),

  reloadDbBtn: document.getElementById('reloadDbBtn'),
  dbStatus: document.getElementById('dbStatus'),
  dbTableBody: document.getElementById('dbTableBody')
};

/* -------- HELPERS -------- */
const fmtDateTime = (s) => s ? new Date(s).toLocaleString(undefined,{dateStyle:'medium',timeStyle:'short'}) : 'N/A';
const toHHMM = (iso) => {
  if (!iso) return '';
  const d = new Date(iso);
  const hh = String(d.getUTCHours()).padStart(2,'0');
  const mm = String(d.getUTCMinutes()).padStart(2,'0');
  return `${hh}${mm}`;
};
const oneOf = (obj, ...keys) => {
  for (const k of keys) {
    const v = obj?.[k];
    if (v !== undefined && v !== null && v !== '') return v;
  }
  return null;
};
const normPath = (v) => {
  if (!v) return '';
  const s = String(v).trim();
  if (s.startsWith('http')) return s;
  // allow both 'xxx.png' and 'detections/xxx.png'
  return RAW_URL(s);
};
const getTelescope = (c) => (c.instrument || c.detector || c.camera || 'unknown').toUpperCase();

/* -------- Normalizer (accepts multiple field shapes) -------- */
function normalizeCandidates(raw, reportName=null){
  const arr = Array.isArray(raw) ? raw : (raw?.candidates || []);
  return arr.map((c, idx) => {
    const telescope = getTelescope(c);
    const id = String(oneOf(c, 'id','candidate_id','name') ?? `${telescope}#${c.track_id ?? idx}`);
    // map many possible keys produced by detector versions
    const originalPath = oneOf(c,
      'original_path','paths?.original','original_mid_path','mid_original','orig_png','png','original');
    const annotatedPath = oneOf(c,
      'annotated_path','paths?.annotated','annotated_mid_path','mid_annotated','annot_png','overlay_png','annotated');
    const cropPath = oneOf(c,
      'crop_path','paths?.crop','crop_png','crop');
    const thumbnail = oneOf(c,
      'thumbnail_path','thumb','thumbnail') || cropPath || originalPath || annotatedPath;
    const gifCrop = oneOf(c, 'animation_gif_crop','gif_path','gif','mid_gif');
    const gifAnn  = oneOf(c, 'animation_gif_ann','gif_annotated','gif_ann');
    const mp4 = oneOf(c, 'mp4_path','mp4','video','mid_mp4');

    const bbox = Array.isArray(c.bbox) ? c.bbox : [];
    let cx = null, cy = null;
    if (Array.isArray(c.centroid) && c.centroid.length === 2) {
      cx = Math.round(c.centroid[0]); cy = Math.round(c.centroid[1]);
    } else if (bbox.length >= 4) {
      const [x,y,w,h] = bbox; cx = Math.round(x + w/2); cy = Math.round(y + h/2);
    }

    return {
      id, telescope,
      label: String(oneOf(c,'ai_label','label') || 'unknown').toLowerCase(),
      score: oneOf(c,'ai_score','score') ?? 0,
      groq_label: (oneOf(c,'groq_label') || '').toLowerCase() || null,
      groq_score: oneOf(c,'groq_score') ?? null,
      timestamp: oneOf(c,'timestamp','t_mid','first_seen','time','t_utc') || '',
      bbox, cx, cy,
      cropPath: cropPath || '',
      originalPath: originalPath || '',
      annotatedPath: annotatedPath || '',
      gifCrop: gifCrop || '',
      gifAnn: gifAnn || '',
      mp4: mp4 || '',
      thumbnail: thumbnail || '',
      positions: c.positions || [],
      imageSize: c.image_size || null,
      trackIndex: c.track_id ?? idx,
      official:false,
      officialInfo:null,
      reportName,
      raw:c
    };
  });
}

/* -------- NASA / Sungrazer -------- */
async function loadNasaCatalog(){
  try{
    const resp = await fetch(NASA_DB_URL);
    const txt = await resp.text();
    const rows = txt.split('\n').filter(l=>l.trim() && !l.startsWith('#'));
    nasaCatalog = rows.map(line=>{
      const parts = line.trim().split(/\s+/);
      if (parts.length < 6) return null;
      const [date, time, x, y, pa, inst, ...notes] = parts;
      return { date, time, x:parseInt(x), y:parseInt(y), inst:String(inst||'').toUpperCase(), notes:notes.join(' ') };
    }).filter(Boolean);
    els.dbStatus.textContent = `Loaded ${nasaCatalog.length} entries`;
    const tail = nasaCatalog.slice(-50);
    els.dbTableBody.innerHTML = tail.map(r=>`<tr>
      <td style="padding:10px 12px;border-bottom:1px solid var(--border)">${r.date}</td>
      <td style="padding:10px 12px;border-bottom:1px solid var(--border)">${r.time}</td>
      <td style="padding:10px 12px;border-bottom:1px solid var(--border)">${r.x}</td>
      <td style="padding:10px 12px;border-bottom:1px solid var(--border)">${r.y}</td>
      <td style="padding:10px 12px;border-bottom:1px solid var(--border)">${r.inst}</td>
      <td style="padding:10px 12px;border-bottom:1px solid var(--border)">${r.notes}</td>
    </tr>`).join('');
    crossCheckCandidates();
  }catch(e){
    els.dbStatus.textContent = 'Failed to load NASA catalogue';
    console.error(e);
  }
}
function crossCheckCandidates(){
  const tol = 50;
  const list = (els.cometSelect.value === '__ALLREPORTS__') ? allFlaggedAcross : allCandidates;
  list.forEach(c=>{
    const inst = c.telescope.includes('C2') ? 'C2' : c.telescope.includes('C3') ? 'C3' : '';
    const match = nasaCatalog.find(db=>{
      if (!inst || db.inst !== inst) return false;
      if (c.cx==null || c.cy==null) return false;
      const ct = c.timestamp ? new Date(c.timestamp) : null;
      const dt = (ct && db.date && db.time) ? Math.abs(ct - new Date(`${db.date}T${db.time}Z`)) : Infinity;
      if (dt > 12*60*60*1000) return false;
      return Math.abs(c.cx - db.x) <= tol && Math.abs(c.cy - db.y) <= tol;
    });
    c.official = !!match;
    c.officialInfo = match || null;
  });
  updateStats(); renderCandidates();
}

/* -------- Report listing & loading (with robust fallbacks) -------- */
async function fetchJSON(url){
  const r = await fetch(url, {cache:'no-store'});
  if (!r.ok) throw new Error(`${r.status} ${r.statusText}`);
  return r.json();
}
async function listReportsViaAPI(){
  try{
    const r = await fetch(GITHUB_API, {headers:{'Accept':'application/vnd.github+json'}});
    if (!r.ok) throw new Error(`list reports failed: ${r.status}`);
    const files = await r.json();
    const names = (Array.isArray(files)?files:[])
      .filter(f=>f.name?.startsWith('candidates_') && f.name.endsWith('.json'))
      .map(f=>f.name)
      .sort((a,b)=> b.localeCompare(a));
    return names;
  }catch(e){
    console.warn('Report listing failed; continuing with latest pointer only', e);
    return [];
  }
}
async function loadReports(){
  // Always try latest pointer first
  let usedLatestPointer = false;
  try{
    const latest = await fetchJSON(RAW_URL('candidates_latest.json'));
    const arr = Array.isArray(latest) ? latest : (Array.isArray(latest?.candidates) ? latest.candidates : []);
    if (arr) {
      allCandidates = normalizeCandidates(arr, 'candidates_latest.json');
      usedLatestPointer = true;
    }
  }catch(_){ /* ignore */ }

  // List historical reports to populate dropdown
  reportNames = await listReportsViaAPI();

  // Build the report dropdown
  const opts = [];
  if (usedLatestPointer) {
    opts.push(`<option value="__LATEST__">latest (pointer)</option>`);
  }
  if (reportNames.length) {
    opts.push(...reportNames.map(name=>{
      const label = name.replace('candidates_','').replace('.json','');
      return `<option value="${name}">${label}</option>`;
    }));
  }
  els.reportSelect.innerHTML = opts.length ? opts.join('') : '<option value="">No reports found</option>';

  // If we have pointer data, render it first; otherwise load newest report if any
  if (usedLatestPointer) {
    updateCandidateDropdowns();
    crossCheckCandidates();
    applyFilters();
  } else if (reportNames.length) {
    await loadReport(reportNames[0]);  // newest
  } else {
    // Nothing to show
    allCandidates = [];
    updateCandidateDropdowns();
    applyFilters();
  }

  // Build global flagged list in background
  buildAllFlaggedAcrossReports();
}

async function loadReport(name){
  if (!name) return;
  if (name === '__LATEST__') {
    try{
      const latest = await fetchJSON(RAW_URL('candidates_latest.json'));
      const arr = Array.isArray(latest) ? latest : (Array.isArray(latest?.candidates) ? latest.candidates : []);
      allCandidates = normalizeCandidates(arr, 'candidates_latest.json');
      updateCandidateDropdowns();
      crossCheckCandidates();
      applyFilters();
    }catch(e){
      console.error('Failed to load latest pointer', e);
    }
    return;
  }
  const url = RAW_URL(name);
  try{
    const resp = await fetch(url, {cache:'no-store'});
    if (!resp.ok) throw new Error(`${resp.status} ${resp.statusText}`);
    const raw = await resp.json();
    allCandidates = normalizeCandidates(raw, name);
    updateCandidateDropdowns();
    crossCheckCandidates();
    applyFilters();
  }catch (e){
    console.error('Fetch failed', url, e);
  }
}

/* -------- Build “All flagged across reports” -------- */
async function buildAllFlaggedAcrossReports(){
  const names = reportNames.slice(0, MAX_REPORTS_TO_SCAN);
  const batches = await Promise.all(
    names.map(async (n)=>{
      try{
        const r = await fetch(RAW_URL(n), {cache:'no-store'});
        if (!r.ok) return [];
        const json = await r.json();
        return normalizeCandidates(json, n).filter(c => c.label==='comet' || c.groq_label==='comet');
      }catch(_){ return []; }
    })
  );
  allFlaggedAcross = batches.flat();

  // add special option to dropdown
  const humanCount = allFlaggedAcross.length;
  const first = els.cometSelect.querySelector('option[value="__ALLREPORTS__"]');
  if (!first){
    const opt = document.createElement('option');
    opt.value = '__ALLREPORTS__';
    opt.textContent = `All flagged (across reports) – ${humanCount}`;
    els.cometSelect.insertBefore(opt, els.cometSelect.firstChild);
  } else {
    first.textContent = `All flagged (across reports) – ${humanCount}`;
  }
}

/* -------- Dropdowns -------- */
function updateCandidateDropdowns(){
  // All candidates (current report)
  els.candidateSelect.innerHTML = '<option value="">All candidates</option>';
  allCandidates.forEach(c=>{
    const pct = isFinite(c.score)? (c.score*100).toFixed(1) : '—';
    const opt = document.createElement('option');
    opt.value = c.id;
    opt.textContent = `${c.id} – ${c.label.toUpperCase()} (${pct}%)`;
    els.candidateSelect.appendChild(opt);
  });

  // Comet candidates (current report)
  const keepAllAcross = els.cometSelect.querySelector('option[value="__ALLREPORTS__"]');
  els.cometSelect.innerHTML = '';
  if (keepAllAcross) els.cometSelect.appendChild(keepAllAcross);
  const def = document.createElement('option');
  def.value = ''; def.textContent = 'All flagged (current report)';
  els.cometSelect.appendChild(def);

  const flagged = allCandidates.filter(c => c.label==='comet' || c.groq_label==='comet');
  flagged.forEach(c=>{
    const ai = isFinite(c.score)? (c.score*100).toFixed(0) : '—';
    const gq = isFinite(c.groq_score)? (c.groq_score*100).toFixed(0) : null;
    const opt = document.createElement('option');
    opt.value = c.id;
    opt.textContent = gq ? `${c.id} – AI ${ai}% / G ${gq}%` : `${c.id} – AI ${ai}%`;
    els.cometSelect.appendChild(opt);
  });
}

/* -------- Filters + Render -------- */
function applyFilters(){
  const fC2 = els.filterC2.checked;
  const fC3 = els.filterC3.checked;
  const fComet = els.filterComet.checked;
  const fMarked = els.filterMarked.checked;
  const showNot = els.showNotComet.checked;

  const selAll = els.candidateSelect.value;
  const selComet = els.cometSelect.value;

  let baseList = allCandidates;
  if (selComet === '__ALLREPORTS__') baseList = allFlaggedAcross;

  filteredCandidates = baseList.filter(c=>{
    if (selComet && selComet !== '__ALLREPORTS__' && c.id !== selComet) return false;
    if (selAll && baseList === allCandidates && c.id !== selAll) return false;
    if (fC2 && !c.telescope.includes('C2')) return false;
    if (fC3 && !c.telescope.includes('C3')) return false;
    if (fComet && c.label !== 'comet') return false;
    if (fMarked && !markedIds.has(c.id)) return false;
    if (!showNot && c.label === 'not_comet') return false;
    return true;
  });

  renderCandidates();
  updateStats();
  els.filterCount.textContent = `Showing ${filteredCandidates.length} of ${baseList.length}${baseList===allFlaggedAcross?' (all reports)':''}`;
}

function renderCandidates(){
  if (!filteredCandidates.length){
    els.candidatesGrid.innerHTML = '';
    els.emptyState.style.display = 'block';
    return;
  }
  els.emptyState.style.display = 'none';
  els.candidatesGrid.innerHTML = filteredCandidates.map(renderCardHTML).join('');
  document.querySelectorAll('.card').forEach(card=>{
    const id = card.dataset.id;
    card.querySelector('.mark')?.addEventListener('click', e => { e.stopPropagation(); toggleMark(id); });
    card.addEventListener('click', () => openModal(id));
  });
}

function renderCardHTML(c){
  const isMarked = markedIds.has(c.id);
  const isOfficial = c.official && els.highlightOfficial.checked;

  // Prefer annotated thumbnail if we later toggle that globally; for now keep original layout: show any reasonable image
  const thumbPath = c.thumbnail || c.cropPath || c.annotatedPath || c.originalPath;
  const thumbURL = normPath(thumbPath);

  const labelCls = (c.label || 'unknown').replace(/\W+/g,'_');
  const cometBadge = (c.groq_label==='comet' ? ' (Groq)' : '');
  const reportTag = c.reportName ? `<div class="k" style="opacity:.85">Report</div>${c.reportName.replace('candidates_','').replace('.json','')}` : '';

  // choose a gif/video to show if present
  const animURL = c.mp4 ? normPath(c.mp4) : (c.gifAnn ? normPath(c.gifAnn) : (c.gifCrop ? normPath(c.gifCrop) : ''));

  return `
    <div class="card" data-id="${c.id}">
      ${thumbURL?`<div class="thumb"><img src="${thumbURL}" alt="${c.id}"></div>`:''}
      ${animURL?`<div class="gif">
        ${animURL.endsWith('.mp4') ? `<video src="${animURL}" playsinline autoplay muted loop style="width:100%"></video>`
                                   : `<img src="${animURL}" loading="lazy" alt="Animation">`}
      </div>`:''}
      <div class="card-b">
        <div class="row">
          <div style="display:flex;flex-direction:column;gap:6px">
            <div style="font-weight:900">${c.id}</div>
            <div style="font-size:13px;color:var(--text-secondary)">${c.telescope}</div>
          </div>
          <div style="text-align:right">
            <div class="chip-label ${labelCls} ${isOfficial?'official':''}">
              ${c.label.toUpperCase()}${isOfficial?' (Official)':''}${cometBadge}
            </div>
            <div style="font:700 12px var(--mono);color:var(--text-secondary);margin-top:6px">
              ${isFinite(c.score)?(c.score*100).toFixed(1):'—'}%
            </div>
          </div>
        </div>
        <div class="meta">
          <div><div class="k">Track</div>${c.trackIndex ?? '—'}</div>
          <div><div class="k">Time</div>${fmtDateTime(c.timestamp)}</div>
          <div><div class="k">Position</div>${(c.cx!=null && c.cy!=null)?`${c.cx}, ${c.cy}`:'—'}</div>
          <div><div class="k">Image</div>${c.imageSize?`${c.imageSize[0]}×${c.imageSize[1]}`:'—'}</div>
          ${c.reportName?`<div style="grid-column:1/-1;display:grid;grid-template-columns:1fr 1fr;gap:8px">${reportTag}</div>`:''}
        </div>
        <div class="actions">
          <button class="btn sm mark">${isMarked?'Unmark':'Mark'}</button>
          <button class="btn sm" onclick="event.stopPropagation(); openModal('${c.id}')">Details</button>
        </div>
      </div>
    </div>`;
}

/* -------- Marking + Stats -------- */
function toggleMark(id){ if(markedIds.has(id)) markedIds.delete(id); else markedIds.add(id); applyFilters(); }
function updateStats(){
  const baseList = (els.cometSelect.value === '__ALLREPORTS__') ? allFlaggedAcross : allCandidates;
  const t = baseList.length;
  const comets = baseList.filter(c=>c.label==='comet' || c.groq_label==='comet').length;
  const c2 = baseList.filter(c=>c.telescope.includes('C2')).length;
  const c3 = baseList.filter(c=>c.telescope.includes('C3')).length;
  const m = markedIds.size;
  const off = baseList.filter(c=>c.official).length;
  document.getElementById('statTotal').textContent = t;
  document.getElementById('statComets').textContent = comets;
  document.getElementById('statC2').textContent = c2;
  document.getElementById('statC3').textContent = c3;
  document.getElementById('statMarked').textContent = m;
  document.getElementById('statOfficial').textContent = off;
}

/* -------- Modal (Original/Annotated/Crop) -------- */
function openModal(id){
  const pool = (els.cometSelect.value === '__ALLREPORTS__') ? allFlaggedAcross : allCandidates;
  const c = pool.find(x=>x.id===id) || allCandidates.find(x=>x.id===id);
  if(!c) return;
  const body = document.getElementById('modalBody');
  const title = document.getElementById('modalTitle');
  title.textContent = `Candidate ${c.id}`;

  const src = {
    ann: c.annotatedPath ? normPath(c.annotatedPath) : '',
    orig: c.originalPath ? normPath(c.originalPath) : '',
    crop: c.cropPath ? normPath(c.cropPath) : ''
  };
  const firstMode = src.ann ? 'ann' : (src.orig ? 'orig' : 'crop');

  let officialBlock = '';
  if (c.officialInfo){
    const oi = c.officialInfo;
    officialBlock = `
      <div style="margin-top:12px;border:1px solid var(--border);border-radius:12px;padding:12px;background:rgba(255,255,255,.04)">
        <strong>Official NASA Record</strong><br/>
        ${oi.date} ${oi.time} • X:${oi.x} Y:${oi.y} • ${oi.inst}<br/>
        ${oi.notes}
      </div>`;
  }

  body.innerHTML = `
    <div>
      <div class="seg" id="segToggle">
        <button data-mode="ann" ${src.ann?'':'disabled'}>Annotated</button>
        <button data-mode="orig" ${src.orig?'':'disabled'}>Original</button>
        <button data-mode="crop" ${src.crop?'':'disabled'}>Cropped</button>
      </div>
      <img id="segImg" class="bigimg" src="${src[firstMode]||''}" alt="view">
      ${(c.gifAnn||c.gifCrop)?`<img class="bigimg" src="${normPath(c.gifAnn||c.gifCrop)}" loading="lazy" alt="Animation">`:''}
      ${officialBlock}
      <div style="margin-top:12px;font-size:14px;color:var(--text-secondary)">
        <div style="display:grid;grid-template-columns:150px 1fr;gap:8px">
          <div class="k">Telescope</div><div>${c.telescope}</div>
          <div class="k">AI Label</div><div>${c.label.toUpperCase()}</div>
          <div class="k">AI Score</div><div>${isFinite(c.score)?(c.score*100).toFixed(2):'—'}%</div>
          <div class="k">Timestamp</div><div>${fmtDateTime(c.timestamp)}</div>
          <div class="k">Track ID</div><div>${c.trackIndex ?? '—'}</div>
          <div class="k">Image Size</div><div>${c.imageSize?`${c.imageSize[0]}×${c.imageSize[1]}`:'—'}</div>
          <div class="k">Position</div><div>${(c.cx!=null && c.cy!=null)?`${c.cx}, ${c.cy}`:'—'}</div>
          ${c.reportName?`<div class="k">Report</div><div>${c.reportName}</div>`:''}
        </div>
      </div>
      <div style="margin-top:12px;display:flex;gap:8px">
        <button class="btn sm" onclick="toggleMark('${c.id}'); closeModal();">Mark/Unmark</button>
        <button class="btn sm" onclick="closeModal()">Close</button>
      </div>
    </div>
  `;

  const seg = body.querySelector('#segToggle');
  const img = body.querySelector('#segImg');
  seg.querySelectorAll('button').forEach(b=>{
    if (b.disabled) return;
    if (b.dataset.mode === firstMode) b.classList.add('active');
    b.addEventListener('click', ()=>{
      seg.querySelectorAll('button').forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      img.src = src[b.dataset.mode] || '';
    });
  });

  document.getElementById('candidateModal').classList.add('active');
}
function closeModal(){ document.getElementById('candidateModal').classList.remove('active'); }

/* -------- Exports -------- */
function downloadText(filename, text){
  const blob = new Blob([text], {type:'application/json;charset=utf-8'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
  a.download = filename; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
}
function getExportSelection(){
  const base = (els.cometSelect.value === '__ALLREPORTS__') ? allFlaggedAcross : allCandidates;
  return els.exportMarkedOnly.checked ? base.filter(c=>markedIds.has(c.id)) : base;
}
function exportTXT(){
  const sel = getExportSelection();
  const lines = sel.map(c => [c.id, c.telescope, c.label, (c.score*100).toFixed(1)+'%', c.timestamp].join('\t'));
  const blob = new Blob([lines.join('\n')], {type:'text/plain;charset=utf-8'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
  a.download = 'export.txt'; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
}
function exportCSV(){
  const sel = getExportSelection();
  const header = ['id','telescope','label','score','timestamp','cx','cy','report'].join(',');
  const rows = sel.map(c=>[
    `"${c.id}"`,`"${c.telescope}"`,`"${c.label}"`,
    isFinite(c.score)?c.score.toFixed(3):'',`"${c.timestamp}"`,
    (c.cx!=null?c.cx:''),(c.cy!=null?c.cy:''),`"${c.reportName||''}"`
  ].join(','));
  const blob = new Blob([[header, ...rows].join('\n')], {type:'text/csv;charset=utf-8'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
  a.download = 'export.csv'; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
}
function exportSungrazer(){
  const objLine = (els.sungrazerObject.value || 'Kreutz Companion').trim();
  const instrPref = els.sungrazerInstrument.value; // 'C2'|'C3'|'auto'
  let sel = getExportSelection().filter(c => c.timestamp && c.cx!=null && c.cy!=null);

  if (instrPref === 'C2' || instrPref === 'C3'){
    sel = sel.filter(c => c.telescope.includes(instrPref));
  }
  const groups = {};
  sel.forEach(c=>{
    const key = (instrPref==='auto')
      ? (c.telescope.includes('C2')?'C2':(c.telescope.includes('C3')?'C3':'OTHER'))
      : instrPref;
    (groups[key]||(groups[key]=[])).push(c);
  });

  let doc = '1024x1024 images\n';
  Object.keys(groups).filter(k=>k!=='OTHER').sort().forEach((inst,idx)=>{
    const g = groups[inst].slice().sort((a,b)=> (a.timestamp||'').localeCompare(b.timestamp||''));
    doc += `${inst}\n${objLine}\n`;
    g.forEach(c=>{ doc += `${toHHMM(c.timestamp)} ${Math.round(c.cx)} ${Math.round(c.cy)}\n`; });
    if (idx < Object.keys(groups).length-1) doc += '\n';
  });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([doc], {type:'text/plain;charset=utf-8'}));
  a.download = 'sungrazer.txt'; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
}
/* Export all-flagged as a single JSON file */
function exportAllFlaggedJSON(){
  const payload = allFlaggedAcross.map(c => ({
    id: c.id,
    telescope: c.telescope,
    label: c.label,
    score: c.score,
    groq_label: c.groq_label,
    groq_score: c.groq_score,
    timestamp: c.timestamp,
    cx: c.cx, cy: c.cy,
    image_size: c.imageSize,
    report: c.reportName,
    paths: { original:c.originalPath, annotated:c.annotatedPath, crop:c.cropPath, gif_ann:c.gifAnn, gif_crop:c.gifCrop, mp4:c.mp4 }
  }));
  downloadText('all_flagged_comets.json', JSON.stringify(payload, null, 2));
}

/* -------- Live + Countdown -------- */
function updateLiveStamps(){
  const t = new Date();
  const hh = String(t.getUTCHours()).padStart(2,'0');
  const mm = String(t.getUTCMinutes()).padStart(2,'0');
  els.c2Timestamp.textContent = `${hh}:${mm} UTC`;
  els.c3Timestamp.textContent = `${hh}:${mm} UTC`;
}
function startCountdown(seconds=300){
  let s = seconds;
  const tick = ()=>{
    const m = String(Math.floor(s/60)).padStart(1,'0');
    const r = String(s%60).padStart(2,'0');
    els.countdown.textContent = `${m}:${r}`;
    if (s<=0){ refreshAll(); s=seconds; } else { s--; }
  };
  tick(); setInterval(tick, 1000);
}
function refreshAll(){
  const sel = els.reportSelect.value;
  if (sel) loadReport(sel);
  updateLiveStamps();
}

/* -------- Events -------- */
els.refreshBtn.addEventListener('click', refreshAll);
els.reportSelect.addEventListener('change', e=> loadReport(e.target.value));
els.candidateSelect.addEventListener('change', applyFilters);
els.cometSelect.addEventListener('change', ()=>{ crossCheckCandidates(); applyFilters(); });
['filterC2','filterC3','filterComet','filterMarked','showNotComet','highlightOfficial'].forEach(id=>{
  els[id].addEventListener('change', applyFilters);
});
els.exportTxtBtn.addEventListener('click', exportTXT);
els.exportCsvBtn.addEventListener('click', exportCSV);
els.exportSungrazerBtn.addEventListener('click', exportSungrazer);
els.exportAllFlaggedBtn.addEventListener('click', exportAllFlaggedJSON);
els.reloadDbBtn.addEventListener('click', loadNasaCatalog);

/* -------- Boot -------- */
loadReports();
loadNasaCatalog();
updateLiveStamps();
startCountdown(300);
  </script>
</body>
</html>

