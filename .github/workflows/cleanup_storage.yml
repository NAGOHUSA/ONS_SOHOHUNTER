  cleanup-artifacts:
    name: Delete Old Artifacts
    runs-on: ubuntu-latest
    permissions:
      actions: write      # For deletion
      contents: read
    steps:
      - name: Delete artifacts older than 7 days
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Compute cutoff timestamp (7 days ago)
          CUTOFF=$(date -u -d '7 days ago' +%s)

          echo "Deleting artifacts created before $(date -u -d "@$CUTOFF")"

          # List all artifacts (paginated), extract ID and creation timestamp
          gh api --paginate \
            repos/${{ github.repository }}/actions/artifacts \
            --jq '.artifacts[] | "\(.id) \(.created_at)"' |
          while read -r id created_at; do
            # Convert created_at to unix timestamp
            ts=$(date -u -d "$created_at" +%s 2>/dev/null || echo 0)

            if [ "$ts" -lt "$CUTOFF" ]; then
              echo "Deleting artifact ID $id (created $created_at)"
              gh api \
                -X DELETE \
                repos/${{ github.repository }}/actions/artifacts/$id \
                || true  # Ignore individual failures
            fi
          done

          echo "Artifact cleanup complete."
