name: SOHO Comet Hunter

on:
  workflow_dispatch:  # This should enable manual run
  schedule:
    - cron: '30 0,2,4,6,8,10,12,14,16,18,20,22 * * *'  # Every 2 hours at :30

permissions:
  contents: write

jobs:
  detect:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg libsm6 libxext6
          pip install numpy opencv-python-headless requests imageio imageio-ffmpeg

      - name: Create directories
        run: |
          mkdir -p frames/C2 frames/C3
          mkdir -p detections

      - name: Download test LASCO images
        run: |
          echo "=== Downloading sample LASCO images ==="
          # Download some sample images for testing
          curl -s -o frames/C2/test_c2_1.jpg "https://soho.nascom.nasa.gov/data/realtime/c2/1024/latest.jpg" || echo "Failed C2"
          curl -s -o frames/C2/test_c2_2.jpg "https://soho.nascom.nasa.gov/data/LATEST/current_c2.jpg" || echo "Failed C2 alt"
          curl -s -o frames/C3/test_c3_1.jpg "https://soho.nascom.nasa.gov/data/realtime/c3/1024/latest.jpg" || echo "Failed C3"
          curl -s -o frames/C3/test_c3_2.jpg "https://soho.nascom.nasa.gov/data/LATEST/current_c3.jpg" || echo "Failed C3 alt"
          
          # Check what we downloaded
          echo "Files in frames/C2:"
          ls -la frames/C2/ || echo "No files"
          echo "Files in frames/C3:"
          ls -la frames/C3/ || echo "No files"

      - name: Create test candidate data
        run: |
          echo "=== Creating test candidate data ==="
          python -c "
import json, datetime, os, random
from pathlib import Path

# Create detections directory
Path('detections').mkdir(exist_ok=True)

# Generate some test candidates
candidates = []
for i in range(1, 6):
    detector = random.choice(['C2', 'C3'])
    timestamp = datetime.datetime.utcnow() - datetime.timedelta(hours=i*2)
    
    candidate = {
        'id': f'{detector}_test_{i}',
        'detector': detector,
        'track_index': i,
        'positions': [
            {
                'frame': f'test_{timestamp.strftime(\"%Y%m%d_%H%M\")}_{detector.lower()}.jpg',
                'time_utc': timestamp.isoformat() + 'Z',
                'x': 400 + random.randint(-100, 100),
                'y': 400 + random.randint(-100, 100)
            }
        ],
        'series_mid_frame': f'test_{timestamp.strftime(\"%Y%m%d_%H%M\")}_{detector.lower()}.jpg',
        'image_size': [1024, 1024],
        'origin': 'upper_left',
        'crop_path': f'crops/test_{i}.png',
        'annotated_path': f'annotated/test_{i}_annotated.png',
        'original_mid_path': f'originals/test_{i}.jpg',
        'ai_label': random.choice(['comet', 'not_comet', 'unknown']),
        'ai_score': round(random.uniform(0.1, 0.9), 2),
        'timestamp': timestamp.isoformat() + 'Z',
        'report_name': 'test_report.json'
    }
    candidates.append(candidate)

# Save to files
timestamp = datetime.datetime.utcnow().strftime('%Y%m%d_%H%M%S')
with open(f'detections/candidates_{timestamp}.json', 'w') as f:
    json.dump(candidates, f, indent=2)

with open('detections/candidates_latest.json', 'w') as f:
    json.dump(candidates, f, indent=2)

# Create summary
summary = {
    'timestamp': datetime.datetime.utcnow().isoformat() + 'Z',
    'total_candidates': len(candidates),
    'c2_candidates': sum(1 for c in candidates if c['detector'] == 'C2'),
    'c3_candidates': sum(1 for c in candidates if c['detector'] == 'C3'),
    'comet_candidates': sum(1 for c in candidates if c['ai_label'] == 'comet'),
    'ai_threshold': 0.4,
    'note': 'Test data - replace with actual detection'
}

with open('detections/latest_status.json', 'w') as f:
    json.dump(summary, f, indent=2)

print(f'Created {len(candidates)} test candidates')
print(f'Comet candidates: {summary[\"comet_candidates\"]}')
          "

      - name: List created files
        run: |
          echo "=== Created detection files ==="
          find detections -name "*.json" -type f -exec echo "  {}" \;

      - name: Commit and push results
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # Force add JSON files
          find detections -name "*.json" -type f -exec git add -f {} \;
          
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ðŸ¤– Auto: SOHO test data $(date -u +'%Y-%m-%d %H:%M UTC')" || echo "Commit failed (maybe no changes)"
            git push || echo "Push failed"
            echo "Changes pushed"
          fi

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: detection-results
          path: |
            detections/
          retention-days: 7
