name: SOHO Comet Hunter (detect) - OPTIMIZED
on:
  schedule:
    - cron: "0 */8 * * *"    # Every 8 hours instead of 6
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: soho-detect
  cancel-in-progress: true  # Stop previous runs

jobs:
  detect:
    runs-on: ubuntu-latest-4core  # Smaller runner
    timeout-minutes: 25  # Much shorter timeout
    
    env:
      AI_MIN_SCORE: "0.60"  # Higher threshold for fewer false positives
      DETECTOR_DEBUG: "0"
      PYTHONUNBUFFERED: "1"
      MAX_IMAGES_PER_RUN: "8"  # Only 8 images total (4 per detector)
      OCCULTER_RADIUS_FRACTION: "0.25"
      MAX_EDGE_RADIUS_FRACTION: "0.90"
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'
      
      - name: Clean up old data
        run: |
          rm -rf frames/C2/* frames/C3/* 2>/dev/null || true
          rm -f detections/candidates_*.json 2>/dev/null || true
      
      - name: Install minimal dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgl1-mesa-glx \
            libsm6 \
            libxext6 \
            ffmpeg
      
      - name: Install Python dependencies
        run: |
          pip install --no-cache-dir \
            numpy>=1.24.0 \
            opencv-python-headless>=4.8.0 \
            requests>=2.31.0 \
            pillow>=10.0.0 \
            tqdm>=4.66.0
      
      - name: Run quick comet detector
        id: detector
        run: |
          set -euxo pipefail
          
          echo "=== Starting QUICK detection at $(date) ==="
          echo "Disk space:"
          df -h
          
          # Strict timeout - 15 minutes max
          timeout 900 python detector/detect_comets.py \
            --hours 4 \
            --step-min 60 \
            --max-images 8 \
            --timeout 840 \
            --out detections \
            2>&1 | tee detector.log
          
          echo "Cleanup temporary files..."
          find . -name "*.fits" -type f -delete 2>/dev/null || true
          find . -name "*.fits.gz" -type f -delete 2>/dev/null || true
      
      - name: Create minimal results if empty
        if: always()
        run: |
          if [ ! -f "detections/candidates_latest.json" ]; then
            echo '{"timestamp_utc": "'$(date -u +"%Y-%m-%dT%H:%M:%SZ")'", "candidates": []}' > detections/candidates_latest.json
          fi
          
          if [ ! -f "detections/latest_status.json" ]; then
            echo '{"timestamp_utc": "'$(date -u +"%Y-%m-%dT%H:%M:%SZ")'", "detectors": {}, "errors": []}' > detections/latest_status.json
          fi
      
      - name: Commit and push results
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add detections/candidates_latest.json detections/latest_status.json
          
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "detect: quick scan $(date -u +%H:%M)Z"
            git push
          fi
      
      - name: Upload failure logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: failure-logs-${{ github.run_number }}
          path: detector.log
          retention-days: 1
