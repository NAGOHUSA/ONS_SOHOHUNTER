name: SOHO Comet Hunter
on:
  schedule:
    - cron: "0 */6 * * *"    # Every 6 hours
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: soho-detect
  cancel-in-progress: true

jobs:
  detect:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    env:
      AI_MIN_SCORE: "0.60"
      DETECTOR_DEBUG: "0"
      PYTHONUNBUFFERED: "1"
      MAX_IMAGES_PER_RUN: "24"
      OCCULTER_RADIUS_FRACTION: "0.20"
      MAX_EDGE_RADIUS_FRACTION: "0.95"
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'
      
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo apt-get clean
          df -h
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgl1-mesa-glx \
            libsm6 \
            libxext6 \
            libxrender-dev
          
          pip install --no-cache-dir \
            numpy \
            opencv-python-headless \
            requests \
            pillow \
            imageio \
            imageio[ffmpeg] \
            tqdm
      
      - name: Create directories
        run: |
          rm -rf frames detections 2>/dev/null || true
          mkdir -p frames/C2 frames/C3
          mkdir -p detections/{crops,annotated,originals,gifs,mp4}
      
      - name: Run comet detector
        id: detector
        run: |
          set -euxo pipefail
          
          echo "=== Starting detection at $(date) ==="
          echo "Disk space:"
          df -h
          
          # Run with timeout protection
          timeout 2400 python detector/detect_comets.py \
            --hours 12 \
            --step-min 30 \
            --max-images ${MAX_IMAGES_PER_RUN} \
            --out detections \
            2>&1 | tee detector.log
          
          # Clean up temp files
          find . -name "*.fits" -type f -delete 2>/dev/null || true
          find . -name "*.fits.gz" -type f -delete 2>/dev/null || true
          
          echo "=== Detection complete ==="
          date
      
      - name: Update candidates list
        if: success()
        run: |
          if [ -f "detector/ensure_candidates_latest.py" ]; then
            python detector/ensure_candidates_latest.py 2>&1 | tee ensure.log || echo "Candidate update failed"
          fi
      
      - name: Create reports manifest
        run: |
          cd detections
          # Find latest candidates file
          latest=$(ls -t candidates_*.json 2>/dev/null | head -n1 || echo "candidates_latest.json")
          echo '{"latest": "'"$latest"'", "reports": ["'"$latest"'"]}' > reports.json
      
      - name: Check results
        run: |
          echo "=== Checking results ==="
          
          if [ -f "detections/candidates_latest.json" ]; then
            candidates=$(python3 -c "import json; data=json.load(open('detections/candidates_latest.json')); print(len(data))")
            echo "Total candidates found: $candidates"
            
            if [ $candidates -gt 0 ]; then
              echo "=== Candidate details ==="
              python3 -c "
import json
data = json.load(open('detections/candidates_latest.json'))
print(f'Total: {len(data)}')
for i, cand in enumerate(data[:5]):
    print(f'{i+1}. Detector: {cand.get(\"detector\")} | AI Score: {cand.get(\"ai_score\", 0):.3f} | Label: {cand.get(\"ai_label\", \"unknown\")}')
if len(data) > 5:
    print(f'... and {len(data)-5} more')
              "
            fi
          else
            echo "WARNING: candidates_latest.json not found!"
          fi
      
      - name: Commit and push results
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Only add JSON files and reports
          git add detections/*.json detections/reports.json
          
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "detect: $(date -u +%Y-%m-%d_%H:%M)Z"
            git push
          fi
      
      - name: Upload results artifact
        uses: actions/upload-artifact@v4
        with:
          name: detections-${{ github.run_number }}
          path: |
            detections/
            detector.log
          retention-days: 7
      
      - name: Upload failure debug
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: failure-debug-${{ github.run_number }}
          path: |
            detector.log
            ensure.log
            frames/
          retention-days: 2
