name: SOHO Comet Hunter

on:
  workflow_dispatch:
  schedule:
    - cron: "30 * * * *"   # hourly at :30 UTC

permissions:
  contents: write

jobs:
  soho:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------
      # Checkout repo
      # -----------------------------
      - name: Checkout
        uses: actions/checkout@v4

      # -----------------------------
      # Python
      # -----------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # -----------------------------
      # Install deps
      # -----------------------------
      - name: Install requirements
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # -----------------------------
      # Ensure output dirs
      # -----------------------------
      - name: Prepare directories
        run: |
          mkdir -p frames
          mkdir -p detections
          mkdir -p detections/reports

      # -----------------------------
      # Fetch LASCO images (24h)
      # -----------------------------
      - name: Fetch SOHO images
        run: |
          python fetch_lasco.py --hours 24

      # -----------------------------
      # Detect comets (24h window)
      # -----------------------------
      - name: Run detector
        run: |
          python detect_comets.py \
            --hours 24 \
            --step-min 12 \
            --out detections

      # -----------------------------
      # Always refresh candidates_latest.json
      # -----------------------------
      - name: Write candidates_latest.json
        run: |
          python - << 'PY'
import json, glob
from pathlib import Path

out_dir = Path("detections")
out_dir.mkdir(exist_ok=True)

latest = out_dir / "candidates_latest.json"
files = sorted(out_dir.glob("candidates_*.json"), reverse=True)

if not files:
    latest.write_text("[]\n", encoding="utf-8")
else:
    data = json.load(open(files[0], "r", encoding="utf-8"))
    if isinstance(data, dict) and "candidates" in data:
        data = data["candidates"]
    json.dump(data if isinstance(data, list) else [], open(latest, "w"), indent=2)
    open(latest, "a").write("\n")

print("Updated candidates_latest.json")
PY

      # -----------------------------
      # Commit outputs
      # -----------------------------
      - name: Commit results
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          if [ -n "$(git status --porcelain detections)" ]; then
            git add detections
            git commit -m "Auto: SOHO detection update $(date -u +'%Y-%m-%d %H:%M UTC')" || true
            git push
          else
            echo "No detection changes"
          fi
