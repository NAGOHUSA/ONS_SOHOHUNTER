name: SOHO Comet Hunter

on:
  workflow_dispatch:
  schedule:
    - cron: '30 0,2,4,6,8,10,12,14,16,18,20,22 * * *'

permissions:
  contents: write

jobs:
  detect:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg libsm6 libxext6
          python -m pip install --upgrade pip
          pip install numpy opencv-python-headless requests imageio imageio-ffmpeg

      - name: Create directories
        run: |
          mkdir -p frames/C2 frames/C3 detections

      - name: Download test LASCO images
        run: |
          echo "=== Downloading sample LASCO images ==="
          curl -f -o frames/C2/test_c2_1.jpg "https://soho.nascom.nasa.gov/data/realtime/c2/1024/latest.jpg"
          curl -f -o frames/C2/test_c2_2.jpg "https://soho.nascom.nasa.gov/data/LATEST/current_c2.jpg"
          curl -f -o frames/C3/test_c3_1.jpg "https://soho.nascom.nasa.gov/data/realtime/c3/1024/latest.jpg"
          curl -f -o frames/C3/test_c3_2.jpg "https://soho.nascom.nasa.gov/data/LATEST/current_c3.jpg"

          echo "Files in frames/C2:"
          ls -la frames/C2
          echo "Files in frames/C3:"
          ls -la frames/C3

      - name: Create test candidate data
        run: |
          python << 'EOF'
          import json, datetime, random
          from pathlib import Path

          Path("detections").mkdir(exist_ok=True)

          candidates = []
          for i in range(1, 6):
              detector = random.choice(["C2", "C3"])
              timestamp = datetime.datetime.utcnow() - datetime.timedelta(hours=i * 2)

              candidates.append({
                  "id": f"{detector}_test_{i}",
                  "detector": detector,
                  "track_index": i,
                  "positions": [{
                      "frame": f"test_{timestamp.strftime('%Y%m%d_%H%M')}_{detector.lower()}.jpg",
                      "time_utc": timestamp.isoformat() + "Z",
                      "x": 400 + random.randint(-100, 100),
                      "y": 400 + random.randint(-100, 100)
                  }],
                  "series_mid_frame": f"test_{timestamp.strftime('%Y%m%d_%H%M')}_{detector.lower()}.jpg",
                  "image_size": [1024, 1024],
                  "origin": "upper_left",
                  "crop_path": f"crops/test_{i}.png",
                  "annotated_path": f"annotated/test_{i}_annotated.png",
                  "original_mid_path": f"originals/test_{i}.jpg",
                  "ai_label": random.choice(["comet", "not_comet", "unknown"]),
                  "ai_score": round(random.uniform(0.1, 0.9), 2),
                  "timestamp": timestamp.isoformat() + "Z",
                  "report_name": "test_report.json"
              })

          now = datetime.datetime.utcnow().strftime("%Y%m%d_%H%M%S")

          with open(f"detections/candidates_{now}.json", "w") as f:
              json.dump(candidates, f, indent=2)

          with open("detections/candidates_latest.json", "w") as f:
              json.dump(candidates, f, indent=2)

          summary = {
              "timestamp": datetime.datetime.utcnow().isoformat() + "Z",
              "total_candidates": len(candidates),
              "c2_candidates": sum(c["detector"] == "C2" for c in candidates),
              "c3_candidates": sum(c["detector"] == "C3" for c in candidates),
              "comet_candidates": sum(c["ai_label"] == "comet" for c in candidates),
              "ai_threshold": 0.4,
              "note": "Test data"
          }

          with open("detections/latest_status.json", "w") as f:
              json.dump(summary, f, indent=2)

          print("Created test detection data")
          EOF

      - name: Commit and push results
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add detections/*.json || true

          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Auto: SOHO test data $(date -u +'%Y-%m-%d %H:%M UTC')"
            git push
          fi

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: detection-results
          path: detections/
          retention-days: 7
