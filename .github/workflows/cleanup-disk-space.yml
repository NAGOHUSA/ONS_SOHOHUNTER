name: Cleanup Disk Space

# Run this workflow manually or before your main workflows
on:
  workflow_dispatch:  # Allows manual trigger
  schedule:
    # Run daily at 2 AM UTC (adjust as needed)
    - cron: '0 2 * * *'

jobs:
  cleanup:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Display initial disk usage
        run: |
          echo "=== Initial Disk Usage ==="
          df -h
          echo ""
          echo "=== Largest directories ==="
          du -h --max-depth=1 / 2>/dev/null | sort -hr | head -20 || true
      
      - name: Free up disk space - Remove unnecessary software
        run: |
          echo "Removing large packages..."
          sudo apt-get remove -y '^aspnetcore-.*' '^dotnet-.*' '^llvm-.*' '^php.*' '^mongodb-.*' '^mysql-.*' azure-cli google-cloud-sdk google-chrome-stable firefox microsoft-edge-stable powershell mono-devel 2>/dev/null || true
          sudo apt-get autoremove -y
          sudo apt-get clean
      
      - name: Free up disk space - Remove Android SDK
        run: |
          echo "Removing Android SDK..."
          sudo rm -rf /usr/local/lib/android || true
      
      - name: Free up disk space - Remove .NET
        run: |
          echo "Removing .NET..."
          sudo rm -rf /usr/share/dotnet || true
      
      - name: Free up disk space - Remove other large tools
        run: |
          echo "Removing other large tools..."
          sudo rm -rf /opt/hostedtoolcache || true
          sudo rm -rf /usr/local/share/boost || true
          sudo rm -rf /usr/local/graalvm || true
          sudo rm -rf /usr/local/.ghcup || true
          sudo rm -rf /usr/local/share/powershell || true
          sudo rm -rf /usr/local/share/chromium || true
          sudo rm -rf /usr/share/swift || true
      
      - name: Free up disk space - Clean Docker
        run: |
          echo "Cleaning Docker..."
          docker system prune -af --volumes || true
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      
      - name: Run comprehensive cleanup script
        run: |
          python cleanup_disk_space.py
      
      - name: Display final disk usage
        run: |
          echo "=== Final Disk Usage ==="
          df -h
          echo ""
          echo "=== Space freed ==="
          df -h / | tail -1 | awk '{print "Available space: " $4}'
      
      - name: Clean up workflow artifacts (optional)
        uses: geekyeggo/delete-artifact@v5
        with:
          name: '*'
          failOnError: false
        continue-on-error: true

# Alternative: Add this as a step at the beginning of your existing workflows
# to prevent disk space issues during runs
