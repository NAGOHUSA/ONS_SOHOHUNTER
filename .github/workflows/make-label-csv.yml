name: Make Label CSV

on:
  workflow_dispatch:
    inputs:
      mode:
        description: "merge = keep existing labels; overwrite = rebuild from crops"
        required: false
        default: "merge"

jobs:
  make-labels:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # Optional: no deps actually required for this workflow
      - name: Prepare Python
        run: |
          python -m pip install --upgrade pip

      - name: Resolve mode
        id: mode
        run: |
          MODE="${{ github.event.inputs.mode }}"
          if [ -z "$MODE" ]; then MODE="merge"; fi
          if [ "$MODE" != "merge" ] && [ "$MODE" != "overwrite" ]; then
            echo "Invalid mode '$MODE' (expected 'merge' or 'overwrite')."
            exit 1
          fi
          echo "mode=$MODE" >> "$GITHUB_OUTPUT"

      # Overwrite mode: rebuild CSV from scratch using your script
      - name: Build labels CSV (overwrite)
        if: ${{ steps.mode.outputs.mode == 'overwrite' }}
        run: |
          set -e
          python scripts/make_label_csv.py
          echo "CSV generated by script (all default to not_comet)."

      # Merge mode: keep existing labels, add new crops with not_comet
      - name: Build labels CSV (merge)
        if: ${{ steps.mode.outputs.mode == 'merge' }}
        run: |
          set -e
          python - <<'PY'
import csv, glob, os

CROPS = sorted(glob.glob("detections/crops/*.png"))
os.makedirs("detector/classifier", exist_ok=True)
CSV_PATH = "detector/classifier/training_labels.csv"

# Load previous labels if present
prev = {}
if os.path.exists(CSV_PATH):
    with open(CSV_PATH, "r", newline="") as f:
        rdr = csv.DictReader(f)
        for row in rdr:
            p = (row.get("path") or "").strip()
            lab = (row.get("label") or "").strip()
            if p:
                prev[p] = lab or "not_comet"

# Merge: keep old labels; add new paths marked not_comet
rows = [{"path": p, "label": prev.get(p, "not_comet")} for p in CROPS]

with open(CSV_PATH, "w", newline="") as f:
    w = csv.DictWriter(f, fieldnames=["path", "label"])
    w.writeheader()
    w.writerows(rows)

print(f"CSV written with {len(rows)} rows to {CSV_PATH} (merge mode).")
PY

      - name: Commit CSV (if changed)
        run: |
          set -e
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add detector/classifier/training_labels.csv
          if git diff --cache
