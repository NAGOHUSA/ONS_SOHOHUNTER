name: Make Label CSV (merge)

on:
  workflow_dispatch: {}

jobs:
  make-labels:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Build labels CSV (merge; keep existing labels)
        run: |
          set -e
          cat > merge_labels.py <<'PY'
          import csv, glob, os
          CROPS = sorted(glob.glob("detections/crops/*.png"))
          os.makedirs("detector/classifier", exist_ok=True)
          CSV_PATH = "detector/classifier/training_labels.csv"

          prev = {}
          if os.path.exists(CSV_PATH):
              with open(CSV_PATH, "r", newline="") as f:
                  rdr = csv.DictReader(f)
                  for row in rdr:
                      p = (row.get("path") or "").strip()
                      lab = (row.get("label") or "").strip()
                      if p:
                          prev[p] = lab or "not_comet"

          rows = [{"path": p, "label": prev.get(p, "not_comet")} for p in CROPS]

          with open(CSV_PATH, "w", newline="") as f:
              w = csv.DictWriter(f, fieldnames=["path", "label"])
              w.writeheader()
              w.writerows(rows)

          print(f"CSV written with {len(rows)} rows to {CSV_PATH} (merge mode).")
          PY
          python merge_labels.py
          rm -f merge_labels.py

      - name: Commit CSV (if changed)
        run: |
          set -e
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add detector/classifier/training_labels.csv
          if git diff --cached --quiet; then
            echo "No CSV changes to commit."
          else
            git commit -m "chore(labels): merge new crops into training_labels.csv"
            git push
          fi
