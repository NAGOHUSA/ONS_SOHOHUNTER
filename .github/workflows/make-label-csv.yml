name: Make Label CSV

on:
  workflow_dispatch:
    inputs:
      mode:
        description: "How to build the CSV: overwrite (run script) or merge (preserve existing labels)"
        required: true
        default: "merge"
        type: choice
        options:
          - merge
          - overwrite

jobs:
  make-labels:
    runs-on: ubuntu-latest
    permissions:
      contents: write   # we will commit training_labels.csv

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # If you don't actually need any pip deps for this, you can delete this step.
      - name: Install requirements (optional)
        run: |
          python -m pip install --upgrade pip

      - name: Build labels CSV (mode = overwrite)
        if: ${{ github.event.inputs.mode == 'overwrite' }}
        run: |
          set -e
          python scripts/make_label_csv.py
          echo "CSV generated by script (all default to not_comet)."

      - name: Build labels CSV (mode = merge â€“ preserve existing labels)
        if: ${{ github.event.inputs.mode == 'merge' }}
        run: |
          set -e
          python - <<'PY'
import csv, glob, os

CROPS = sorted(glob.glob("detections/crops/*.png"))
os.makedirs("detector/classifier", exist_ok=True)
CSV_PATH = "detector/classifier/training_labels.csv"

# load previous labels if present
prev = {}
if os.path.exists(CSV_PATH):
    with open(CSV_PATH, "r", newline="") as f:
        rdr = csv.DictReader(f)
        for row in rdr:
            p = (row.get("path") or "").strip()
            lab = (row.get("label") or "").strip()
            if p:
                prev[p] = lab or "not_comet"

# merge: keep old labels, add new paths with default not_comet
rows = []
for p in CROPS:
    rows.append({"path": p, "label": prev.get(p, "not_comet")})

with open(CSV_PATH, "w", newline="") as f:
    w = csv.DictWriter(f, fieldnames=["path", "label"])
    w.writeheader()
    w.writerows(rows)

print(f"CSV written with {len(rows)} rows to {CSV_PATH} (merge mode).")
PY

      - name: Commit CSV (if changed)
        run: |
          set -e
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add detector/classifier/training_labels.csv
          if git diff --cached --quiet; then
            echo "No CSV changes to commit."
          else
            MODE="${{ github.event.inputs.mode }}"
            git commit -m "chore(labels): update training_labels.csv (${MODE} mode)"
            git push
          fi
